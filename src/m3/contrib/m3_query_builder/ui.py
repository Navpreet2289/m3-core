#coding:utf-8 
'''
Date&Time: 01.06.11 10:28
@author: kir
'''
from m3.ui.ext.containers.containers import ExtContainer, ExtToolBar
from m3.ui.ext.containers.forms import ExtPanel, ExtTabPanel
from m3.ui.ext.containers.grids import ExtGrid, ExtGridColumn
from m3.ui.ext.containers.trees import ExtTree
from m3.ui.ext.controls.buttons import ExtButton
from m3.ui.ext.fields.simple import ExtCheckBox, ExtNumberField
from m3.ui.ext.misc.store import ExtJsonStore
from m3.ui.ext.windows.window import ExtWindow

class queryBuilderWindow(ExtWindow):

    def __init__(self, params={}, *args, **kwargs):
        super(queryBuilderWindow, self).__init__(*args, **kwargs)
        self.initialize()
        #Как бы хак
        self.button_align = ExtWindow.align_left
        #Добавляем элементы в таб панель
        self.tab_tappanel_1.items.extend([self.init_tables_and_connections(),
                                          self.init_fields(),
                                          self.init_grouping(),
                                          self.init_conditions()])
        self.template_globals = 'query-builder-window.js'
        self.params = params

    def initialize(self):
        '''AUTOGENERATED'''
        self.layout = 'fit'
        self.title = u'Редактор запросов'
        self.maximizable = True
        self.minimizable = True
        self.min_height = 600
        self.height = 600
        self.min_width = 800
        self.width = 800

        tb_toolbar_1 = ExtToolBar()
        tb_toolbar_1.layout = 'toolbar'

        tbfill_toolbarfill_1 = ExtToolBar.Fill()

        query_text = ExtButton()
        query_text.text = u'Показать текст запроса'
        query_text.icon_cls = 'icon-script-code'

        run_query = ExtButton()
        run_query.text = u'Выполнить'
        run_query.icon_cls = 'icon-script-lightning'

        save_query = ExtButton()
        save_query.text = u'Сохранить'
        save_query.icon_cls = 'icon-script-save'

        close = ExtButton()
        close.text = u'Закрыть'
        close.handler = 'winClose'
        close.icon_cls = 'icon-door-out'

        tab_tappanel_1 = ExtTabPanel()
        tab_tappanel_1.title = 'New panel'
        tab_tappanel_1.active_tab = 0
        tab_tappanel_1.body_border = False
        tab_tappanel_1.header = True
        tab_tappanel_1.border = False

        self.footer_bar = tb_toolbar_1

        tb_toolbar_1.items.extend([query_text, tbfill_toolbarfill_1, run_query, save_query, close])
        self.items.extend([tab_tappanel_1])

        self.tb_toolbar_1 = tb_toolbar_1
        self.tbfill_toolbarfill_1 = tbfill_toolbarfill_1
        self.query_text = query_text
        self.run_query = run_query
        self.save_query = save_query
        self.close = close
        self.tab_tappanel_1 = tab_tappanel_1

    def init_tables_and_connections(self, container_class=ExtPanel):
        cont = container_class()
        cont.layout = 'border'
        cont.title = u'Таблицы и связи'

        cnt_container_2 = ExtContainer()
        cnt_container_2.region = 'center'
        cnt_container_2.layout = 'border'

        grd_gridpanel_1 = ExtGrid()
        grd_gridpanel_1.layout = 'auto'
        grd_gridpanel_1.title = u'Выбранные сущности'
        grd_gridpanel_1.region = 'north'
        grd_gridpanel_1.height = 200
        grd_gridpanel_1.header = True

        jstore_jsonstore_1 = ExtJsonStore()
        jstore_jsonstore_1.id_property = 'id'
        jstore_jsonstore_1.store_id = 'newJsonStore'

        clmn_gridColumn_1 = ExtGridColumn()
        clmn_gridColumn_1.header = u'Наименование'
        clmn_gridColumn_1.data_index = 'entity_name'
        clmn_gridColumn_1.menu_disabled = True

        grd_gridpanel_2 = ExtGrid()
        grd_gridpanel_2.layout = 'auto'
        grd_gridpanel_2.title = u'Выбранные сущности'
        grd_gridpanel_2.region = 'center'
        grd_gridpanel_2.header = True

        tb_toolbar_1 = ExtToolBar()
        tb_toolbar_1.layout = 'toolbar'

        select_connection = ExtButton()
        select_connection.text = u'Выбрать связь'
        select_connection.icon_cls = 'icon-link-add'
        select_connection.handler = 'selectConnection'

        delete_connection = ExtButton()
        delete_connection.name = 'deleteConnection'
        delete_connection.text = u'Удалить связь'
        delete_connection.handler = 'delete_connection'
        delete_connection.icon_cls = 'icon-link-delete'

        jstore_jsonstore_2 = ExtJsonStore()
        jstore_jsonstore_2.id_property = 'id'
        jstore_jsonstore_2.store_id = 'newJsonStore'

        clmn_gridColumn_2 = ExtGridColumn()
        clmn_gridColumn_2.menu_disabled = True
        clmn_gridColumn_2.header = u'№'
        clmn_gridColumn_2.width = 30
        clmn_gridColumn_2.data_index = 'number'

        clmn_gridColumn_3 = ExtGridColumn()
        clmn_gridColumn_3.header = u'Сущность 1'
        clmn_gridColumn_3.data_index = 'entity_1'
        clmn_gridColumn_3.menu_disabled = True

        clmn_gridColumn_4 = ExtGridColumn()
        clmn_gridColumn_4.menu_disabled = True
        clmn_gridColumn_4.header = u'Вн.'
        clmn_gridColumn_4.width = 30
        clmn_gridColumn_4.data_index = 'inner_1'

        clmn_gridColumn_5 = ExtGridColumn()
        clmn_gridColumn_5.header = u'Сущность 2'
        clmn_gridColumn_5.data_index = 'entity_2'
        clmn_gridColumn_5.menu_disabled = True

        clmn_gridColumn_6 = ExtGridColumn()
        clmn_gridColumn_6.menu_disabled = True
        clmn_gridColumn_6.header = u'Вн.'
        clmn_gridColumn_6.width = 30
        clmn_gridColumn_6.data_index = 'inner_2'

        clmn_gridColumn_7 = ExtGridColumn()
        clmn_gridColumn_7.header = u'Тип связи'
        clmn_gridColumn_7.data_index = 'connection_type'
        clmn_gridColumn_7.menu_disabled = True

        tree_treepanel_1 = ExtTree()
        tree_treepanel_1.layout = 'auto'
        tree_treepanel_1.width = 200
        tree_treepanel_1.region = 'west'
        tree_treepanel_1.title = u'Дерево схем'
        tree_treepanel_1.root_text = 'Root'
        tree_treepanel_1.header = True

        clmn_gridColumn_8 = ExtGridColumn()
        clmn_gridColumn_8.header = u'Схемы'
        clmn_gridColumn_8.data_index = 'schemes'
        clmn_gridColumn_8.menu_disabled = True

        grd_gridpanel_1.store = jstore_jsonstore_1
        grd_gridpanel_2.top_bar = tb_toolbar_1
        grd_gridpanel_2.store = jstore_jsonstore_2

        grd_gridpanel_1.columns.extend([clmn_gridColumn_1])
        tb_toolbar_1.items.extend([select_connection, delete_connection])
        grd_gridpanel_2.columns.extend([clmn_gridColumn_2, clmn_gridColumn_3, clmn_gridColumn_4, clmn_gridColumn_5, clmn_gridColumn_6, clmn_gridColumn_7])
        cnt_container_2.items.extend([grd_gridpanel_1, grd_gridpanel_2])
        tree_treepanel_1.columns.extend([clmn_gridColumn_8])
        cont.items.extend([cnt_container_2, tree_treepanel_1])

        self.cnt_container_2 = cnt_container_2
        self.grd_gridpanel_1 = grd_gridpanel_1
        self.jstore_jsonstore_1 = jstore_jsonstore_1
        self.clmn_gridColumn_1 = clmn_gridColumn_1
        self.grd_gridpanel_2 = grd_gridpanel_2
        self.tb_toolbar_1 = tb_toolbar_1
        self.select_connection = select_connection
        self.delete_connection = delete_connection
        self.jstore_jsonstore_2 = jstore_jsonstore_2
        self.clmn_gridColumn_2 = clmn_gridColumn_2
        self.clmn_gridColumn_3 = clmn_gridColumn_3
        self.clmn_gridColumn_4 = clmn_gridColumn_4
        self.clmn_gridColumn_5 = clmn_gridColumn_5
        self.clmn_gridColumn_6 = clmn_gridColumn_6
        self.clmn_gridColumn_7 = clmn_gridColumn_7
        self.tree_treepanel_1 = tree_treepanel_1
        self.clmn_gridColumn_8 = clmn_gridColumn_8

        return cont


    def init_fields(self, container_class=ExtPanel):
        cont = container_class()
        cont.layout = 'border'
        cont.title = u'Поля'
        cont.padding = '10px'

        cnt_container_2 = ExtContainer()
        cnt_container_2.region = 'center'
        cnt_container_2.layout = 'border'

        tree_treepanel_1 = ExtTree()
        tree_treepanel_1.layout = 'auto'
        tree_treepanel_1.header = False
        tree_treepanel_1.region = 'west'
        tree_treepanel_1.root_text = 'Root'
        tree_treepanel_1.width = 150

        clmn_gridColumn_4 = ExtGridColumn()
        clmn_gridColumn_4.header = u'Схемы'
        clmn_gridColumn_4.data_index = 'fields_shemes'
        clmn_gridColumn_4.menu_disabled = True

        grd_gridpanel_1 = ExtGrid()
        grd_gridpanel_1.layout = 'auto'
        grd_gridpanel_1.region = 'center'
        grd_gridpanel_1.header = False

        jstore_jsonstore_1 = ExtJsonStore()
        jstore_jsonstore_1.id_property = 'id'
        jstore_jsonstore_1.store_id = 'newJsonStore'

        clmn_gridColumn_1 = ExtGridColumn()
        clmn_gridColumn_1.header = u'Выбранное поле'
        clmn_gridColumn_1.data_index = 'selected_field'
        clmn_gridColumn_1.menu_disabled = True

        clmn_gridColumn_2 = ExtGridColumn()
        clmn_gridColumn_2.header = u'Алиас'
        clmn_gridColumn_2.data_index = 'alias'
        clmn_gridColumn_2.menu_disabled = True

        clmn_gridColumn_3 = ExtGridColumn()
        clmn_gridColumn_3.menu_disabled = True
        clmn_gridColumn_3.header = u'Сортировка'
        clmn_gridColumn_3.width = 80
        clmn_gridColumn_3.data_index = 'sorting'

        pnl_panel_2 = ExtPanel()
        pnl_panel_2.layout = 'auto'
        pnl_panel_2.title = u'Опции'
        pnl_panel_2.region = 'north'
        pnl_panel_2.height = 80
        pnl_panel_2.padding = '5px'
        pnl_panel_2.header = True

        chk_checkbox_1 = ExtCheckBox()
        chk_checkbox_1.box_label = 'Distinct'
        chk_checkbox_1.checked = False

        cnt_container_3 = ExtContainer()
        cnt_container_3.layout = 'hbox'

        chk_checkbox_2 = ExtCheckBox()
        chk_checkbox_2.width = 80
        chk_checkbox_2.box_label = 'Limit'

        nmbr_numberfield_1 = ExtNumberField()
        nmbr_numberfield_1.flex = 0

        grd_gridpanel_1.store = jstore_jsonstore_1

        tree_treepanel_1.columns.extend([clmn_gridColumn_4])
        grd_gridpanel_1.columns.extend([clmn_gridColumn_1, clmn_gridColumn_2, clmn_gridColumn_3])
        cnt_container_2.items.extend([tree_treepanel_1, grd_gridpanel_1])
        cnt_container_3.items.extend([chk_checkbox_2, nmbr_numberfield_1])
        pnl_panel_2.items.extend([chk_checkbox_1, cnt_container_3])
        cont.items.extend([cnt_container_2, pnl_panel_2])

        self.cnt_container_2 = cnt_container_2
        self.tree_treepanel_1 = tree_treepanel_1
        self.clmn_gridColumn_4 = clmn_gridColumn_4
        self.grd_gridpanel_1 = grd_gridpanel_1
        self.jstore_jsonstore_1 = jstore_jsonstore_1
        self.clmn_gridColumn_1 = clmn_gridColumn_1
        self.clmn_gridColumn_2 = clmn_gridColumn_2
        self.clmn_gridColumn_3 = clmn_gridColumn_3
        self.pnl_panel_2 = pnl_panel_2
        self.chk_checkbox_1 = chk_checkbox_1
        self.cnt_container_3 = cnt_container_3
        self.chk_checkbox_2 = chk_checkbox_2
        self.nmbr_numberfield_1 = nmbr_numberfield_1

        return cont


    def init_grouping(self, container_class=ExtPanel):
        cont = container_class()
        cont.layout = 'border'
        cont.title = u'Группировка'

        tree_treepanel_1 = ExtTree()
        tree_treepanel_1.layout = 'auto'
        tree_treepanel_1.width = 200
        tree_treepanel_1.region = 'west'
        tree_treepanel_1.title = u'Дерево'
        tree_treepanel_1.root_text = 'Root'
        tree_treepanel_1.header = True

        clmn_gridColumn_1 = ExtGridColumn()
        clmn_gridColumn_1.header = u'Поля'
        clmn_gridColumn_1.data_index = 'grouping_fields'
        clmn_gridColumn_1.menu_disabled = True

        cnt_container_1 = ExtContainer()
        cnt_container_1.region = 'center'
        cnt_container_1.layout = 'border'

        grd_gridpanel_1 = ExtGrid()
        grd_gridpanel_1.layout = 'auto'
        grd_gridpanel_1.title = u'Групповое поле'
        grd_gridpanel_1.region = 'north'
        grd_gridpanel_1.height = 250
        grd_gridpanel_1.header = True

        jstore_jsonstore_2 = ExtJsonStore()
        jstore_jsonstore_2.id_property = 'id'
        jstore_jsonstore_2.store_id = 'newJsonStore'

        clmn_gridColumn_2 = ExtGridColumn()
        clmn_gridColumn_2.header = u'Наименование'
        clmn_gridColumn_2.data_index = 'name'
        clmn_gridColumn_2.menu_disabled = True

        grd_gridpanel_2 = ExtGrid()
        grd_gridpanel_2.layout = 'auto'
        grd_gridpanel_2.title = u'Суммируемое поле'
        grd_gridpanel_2.region = 'center'
        grd_gridpanel_2.header = True

        jstore_jsonstore_1 = ExtJsonStore()
        jstore_jsonstore_1.id_property = 'id'
        jstore_jsonstore_1.store_id = 'newJsonStore'

        clmn_gridColumn_3 = ExtGridColumn()
        clmn_gridColumn_3.header = u'Суммируемое поле'
        clmn_gridColumn_3.data_index = 'summable_field'
        clmn_gridColumn_3.menu_disabled = True

        clmn_gridColumn_4 = ExtGridColumn()
        clmn_gridColumn_4.header = u'Функцция'
        clmn_gridColumn_4.data_index = 'function'
        clmn_gridColumn_4.menu_disabled = True

        grd_gridpanel_1.store = jstore_jsonstore_2
        grd_gridpanel_2.store = jstore_jsonstore_1

        tree_treepanel_1.columns.extend([clmn_gridColumn_1])
        grd_gridpanel_1.columns.extend([clmn_gridColumn_2])
        grd_gridpanel_2.columns.extend([clmn_gridColumn_3, clmn_gridColumn_4])
        cnt_container_1.items.extend([grd_gridpanel_1, grd_gridpanel_2])
        cont.items.extend([tree_treepanel_1, cnt_container_1])

        self.tree_treepanel_1 = tree_treepanel_1
        self.clmn_gridColumn_1 = clmn_gridColumn_1
        self.cnt_container_1 = cnt_container_1
        self.grd_gridpanel_1 = grd_gridpanel_1
        self.jstore_jsonstore_2 = jstore_jsonstore_2
        self.clmn_gridColumn_2 = clmn_gridColumn_2
        self.grd_gridpanel_2 = grd_gridpanel_2
        self.jstore_jsonstore_1 = jstore_jsonstore_1
        self.clmn_gridColumn_3 = clmn_gridColumn_3
        self.clmn_gridColumn_4 = clmn_gridColumn_4

        return cont


    def init_conditions(self, container_class=ExtPanel):
        cont = container_class()
        cont.layout = 'border'
        cont.title = u'Условия'

        tree_treepanel_1 = ExtTree()
        tree_treepanel_1.flex = 0
        tree_treepanel_1.layout = 'auto'
        tree_treepanel_1.title = u'Все поля'
        tree_treepanel_1.region = 'west'
        tree_treepanel_1.root_text = 'Root'
        tree_treepanel_1.header = True
        tree_treepanel_1.width = 200

        clmn_gridColumn_2 = ExtGridColumn()
        clmn_gridColumn_2.header = u'Схемы'
        clmn_gridColumn_2.menu_disabled = True
        clmn_gridColumn_2.data_index = 'conditions_schemes'

        grd_gridpanel_1 = ExtGrid()
        grd_gridpanel_1.layout = 'auto'
        grd_gridpanel_1.title = u'Условия'
        grd_gridpanel_1.region = 'center'
        grd_gridpanel_1.header = True

        jstore_jsonstore_1 = ExtJsonStore()
        jstore_jsonstore_1.id_property = 'id'
        jstore_jsonstore_1.store_id = 'newJsonStore'

        clmn_gridColumn_2 = ExtGridColumn()
        clmn_gridColumn_2.header = u'Условия'
        clmn_gridColumn_2.data_index = 'conditions'
        clmn_gridColumn_2.menu_disabled = True

        grd_gridpanel_1.store = jstore_jsonstore_1

        tree_treepanel_1.columns.extend([clmn_gridColumn_2])
        grd_gridpanel_1.columns.extend([clmn_gridColumn_2])
        cont.items.extend([tree_treepanel_1, grd_gridpanel_1])

        self.tree_treepanel_1 = tree_treepanel_1
        self.clmn_gridColumn_2 = clmn_gridColumn_2
        self.grd_gridpanel_1 = grd_gridpanel_1
        self.jstore_jsonstore_1 = jstore_jsonstore_1
        self.clmn_gridColumn_2 = clmn_gridColumn_2

        return cont

class selectConnectionsWindow(ExtWindow):

    def __init__(self, *args, **kwargs):
        super(selectConnectionsWindow, self).__init__(*args, **kwargs)
        self.initialize()

    def initialize(self):
        '''AUTOGENERATED'''
        self.layout = 'auto'
        self.title = u'Выбранные схемы'
        self.min_height = 300
        self.height = 300
        self.min_width = 400
        self.width = 400
        self.maximizable = True
        self.minimizable = True

        tb_toolbar_1 = ExtToolBar()
        tb_toolbar_1.layout = 'toolbar'

        select = ExtButton()
        select.text = u'Выбрать'

        cancel = ExtButton()
        cancel.text = u'Отмена'

        cnt_container_3 = ExtContainer()
        cnt_container_3.layout = 'hbox'

        tree_treepanel_1 = ExtTree()
        tree_treepanel_1.flex = '1'
        tree_treepanel_1.layout = 'auto'
        tree_treepanel_1.root_text = 'Root'
        tree_treepanel_1.header = False

        scheme_1 = ExtGridColumn()
        scheme_1.header = u'Схема'
        scheme_1.data_index = 'scheme_1'
        scheme_1.menu_disabled = True

        tree_treepanel_2 = ExtTree()
        tree_treepanel_2.flex = '1'
        tree_treepanel_2.layout = 'auto'
        tree_treepanel_2.root_text = 'Root'
        tree_treepanel_2.header = False

        scheme_2 = ExtGridColumn()
        scheme_2.header = u'Схема'
        scheme_2.data_index = 'scheme_2'
        scheme_2.menu_disabled = True

        cnt_container_2 = ExtContainer()
        cnt_container_2.layout = 'hbox'
        cnt_container_2.style = {'padding': '5px'}

        chk_checkbox_1 = ExtCheckBox()
        chk_checkbox_1.flex = 1
        chk_checkbox_1.box_label = u'Внешняя связь'

        chk_checkbox_2 = ExtCheckBox()
        chk_checkbox_2.flex = 1
        chk_checkbox_2.box_label = u'Внешняя связь'

        self.footer_bar = tb_toolbar_1

        tb_toolbar_1.items.extend([select, cancel])
        tree_treepanel_1.columns.extend([scheme_1])
        tree_treepanel_2.columns.extend([scheme_2])
        cnt_container_3.items.extend([tree_treepanel_1, tree_treepanel_2])
        cnt_container_2.items.extend([chk_checkbox_1, chk_checkbox_2])
        self.items.extend([cnt_container_3, cnt_container_2])

        self.tb_toolbar_1 = tb_toolbar_1
        self.select = select
        self.cancel = cancel
        self.cnt_container_3 = cnt_container_3
        self.tree_treepanel_1 = tree_treepanel_1
        self.scheme_1 = scheme_1
        self.tree_treepanel_2 = tree_treepanel_2
        self.scheme_2 = scheme_2
        self.cnt_container_2 = cnt_container_2
        self.chk_checkbox_1 = chk_checkbox_1
        self.chk_checkbox_2 = chk_checkbox_2
        