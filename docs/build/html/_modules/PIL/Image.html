

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>PIL.Image &mdash; M3 v0.6 documentation</title>
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="M3 v0.6 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../../index.html">M3 v0.6 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for PIL.Image</h1><div class="highlight"><pre>
<span class="c">#</span>
<span class="c"># The Python Imaging Library.</span>
<span class="c"># $Id$</span>
<span class="c">#</span>
<span class="c"># the Image class wrapper</span>
<span class="c">#</span>
<span class="c"># partial release history:</span>
<span class="c"># 1995-09-09 fl   Created</span>
<span class="c"># 1996-03-11 fl   PIL release 0.0 (proof of concept)</span>
<span class="c"># 1996-04-30 fl   PIL release 0.1b1</span>
<span class="c"># 1999-07-28 fl   PIL release 1.0 final</span>
<span class="c"># 2000-06-07 fl   PIL release 1.1</span>
<span class="c"># 2000-10-20 fl   PIL release 1.1.1</span>
<span class="c"># 2001-05-07 fl   PIL release 1.1.2</span>
<span class="c"># 2002-03-15 fl   PIL release 1.1.3</span>
<span class="c"># 2003-05-10 fl   PIL release 1.1.4</span>
<span class="c"># 2005-03-28 fl   PIL release 1.1.5</span>
<span class="c"># 2006-12-02 fl   PIL release 1.1.6</span>
<span class="c"># 2009-11-15 fl   PIL release 1.1.7</span>
<span class="c">#</span>
<span class="c"># Copyright (c) 1997-2009 by Secret Labs AB.  All rights reserved.</span>
<span class="c"># Copyright (c) 1995-2009 by Fredrik Lundh.</span>
<span class="c">#</span>
<span class="c"># See the README file for information on usage and redistribution.</span>
<span class="c">#</span>

<span class="n">VERSION</span> <span class="o">=</span> <span class="s">&quot;1.1.7&quot;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">warnings</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warnings</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">_imaging_not_installed</span><span class="p">:</span>
    <span class="c"># module placeholder</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s">&quot;The _imaging C module is not installed&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c"># give Tk a chance to set up the environment, in case we&#39;re</span>
    <span class="c"># using an _imaging module linked against libtcl/libtk (use</span>
    <span class="c"># __import__ to hide this from naive packagers; we don&#39;t really</span>
    <span class="c"># depend on Tk unless ImageTk is used, and that module already</span>
    <span class="c"># imports Tkinter)</span>
    <span class="nb">__import__</span><span class="p">(</span><span class="s">&quot;FixTk&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c"># If the _imaging C module is not present, you can still use</span>
    <span class="c"># the &quot;open&quot; function to identify files, but you cannot load</span>
    <span class="c"># them.  Note that other modules should not refer to _imaging</span>
    <span class="c"># directly; import Image and use the Image.core variable instead.</span>
    <span class="kn">import</span> <span class="nn">_imaging</span>
    <span class="n">core</span> <span class="o">=</span> <span class="n">_imaging</span>
    <span class="k">del</span> <span class="n">_imaging</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span>
    <span class="n">core</span> <span class="o">=</span> <span class="n">_imaging_not_installed</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)[:</span><span class="mi">20</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Module use of python&quot;</span> <span class="ow">and</span> <span class="n">warnings</span><span class="p">:</span>
        <span class="c"># The _imaging C module is present, but not compiled for</span>
        <span class="c"># the right version (windows only).  Print a warning, if</span>
        <span class="c"># possible.</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s">&quot;The _imaging extension was built for another version &quot;</span>
            <span class="s">&quot;of Python; most PIL functions will be disabled&quot;</span><span class="p">,</span>
            <span class="ne">RuntimeWarning</span>
            <span class="p">)</span>

<span class="kn">import</span> <span class="nn">ImageMode</span>
<span class="kn">import</span> <span class="nn">ImagePalette</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">string</span><span class="o">,</span> <span class="nn">sys</span>

<span class="c"># type stuff</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">IntType</span><span class="p">,</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">TupleType</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">UnicodeStringType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">))</span>
    <span class="c">##</span>
    <span class="c"># (Internal) Checks if an object is a string.  If the current</span>
    <span class="c"># Python version supports Unicode, this checks for both 8-bit</span>
    <span class="c"># and Unicode strings.</span>
    <span class="k">def</span> <span class="nf">isStringType</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">StringType</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">UnicodeStringType</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">isStringType</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">StringType</span><span class="p">)</span>

<span class="c">##</span>
<span class="c"># (Internal) Checks if an object is a tuple.</span>

<span class="k">def</span> <span class="nf">isTupleType</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">TupleType</span><span class="p">)</span>

<span class="c">##</span>
<span class="c"># (Internal) Checks if an object is an image object.</span>

<span class="k">def</span> <span class="nf">isImageType</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&quot;im&quot;</span><span class="p">)</span>

<span class="c">##</span>
<span class="c"># (Internal) Checks if an object is a string, and that it points to a</span>
<span class="c"># directory.</span>

<span class="k">def</span> <span class="nf">isDirectory</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">isStringType</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">isNumberType</span><span class="p">,</span> <span class="n">isSequenceType</span>

<span class="c">#</span>
<span class="c"># Debug level</span>

<span class="n">DEBUG</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c">#</span>
<span class="c"># Constants (also defined in _imagingmodule.c!)</span>

<span class="n">NONE</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c"># transpose</span>
<span class="n">FLIP_LEFT_RIGHT</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">FLIP_TOP_BOTTOM</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">ROTATE_90</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">ROTATE_180</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">ROTATE_270</span> <span class="o">=</span> <span class="mi">4</span>

<span class="c"># transforms</span>
<span class="n">AFFINE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">EXTENT</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">PERSPECTIVE</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">QUAD</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">MESH</span> <span class="o">=</span> <span class="mi">4</span>

<span class="c"># resampling filters</span>
<span class="n">NONE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">NEAREST</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ANTIALIAS</span> <span class="o">=</span> <span class="mi">1</span> <span class="c"># 3-lobed lanczos</span>
<span class="n">LINEAR</span> <span class="o">=</span> <span class="n">BILINEAR</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">CUBIC</span> <span class="o">=</span> <span class="n">BICUBIC</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c"># dithers</span>
<span class="n">NONE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">NEAREST</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ORDERED</span> <span class="o">=</span> <span class="mi">1</span> <span class="c"># Not yet implemented</span>
<span class="n">RASTERIZE</span> <span class="o">=</span> <span class="mi">2</span> <span class="c"># Not yet implemented</span>
<span class="n">FLOYDSTEINBERG</span> <span class="o">=</span> <span class="mi">3</span> <span class="c"># default</span>

<span class="c"># palettes/quantizers</span>
<span class="n">WEB</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ADAPTIVE</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c"># categories</span>
<span class="n">NORMAL</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">SEQUENCE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">CONTAINER</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c"># --------------------------------------------------------------------</span>
<span class="c"># Registries</span>

<span class="n">ID</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">OPEN</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">MIME</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">SAVE</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">EXTENSION</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c"># --------------------------------------------------------------------</span>
<span class="c"># Modes supported by this version</span>

<span class="n">_MODEINFO</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c"># NOTE: this table will be removed in future versions.  use</span>
    <span class="c"># getmode* functions or ImageMode descriptors instead.</span>

    <span class="c"># official modes</span>
    <span class="s">&quot;1&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">,)),</span>
    <span class="s">&quot;L&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;L&quot;</span><span class="p">,)),</span>
    <span class="s">&quot;I&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="s">&quot;I&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;I&quot;</span><span class="p">,)),</span>
    <span class="s">&quot;F&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="s">&quot;F&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;F&quot;</span><span class="p">,)),</span>
    <span class="s">&quot;P&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s">&quot;RGB&quot;</span><span class="p">,</span> <span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;P&quot;</span><span class="p">,)),</span>
    <span class="s">&quot;RGB&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s">&quot;RGB&quot;</span><span class="p">,</span> <span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;R&quot;</span><span class="p">,</span> <span class="s">&quot;G&quot;</span><span class="p">,</span> <span class="s">&quot;B&quot;</span><span class="p">)),</span>
    <span class="s">&quot;RGBX&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s">&quot;RGB&quot;</span><span class="p">,</span> <span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;R&quot;</span><span class="p">,</span> <span class="s">&quot;G&quot;</span><span class="p">,</span> <span class="s">&quot;B&quot;</span><span class="p">,</span> <span class="s">&quot;X&quot;</span><span class="p">)),</span>
    <span class="s">&quot;RGBA&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s">&quot;RGB&quot;</span><span class="p">,</span> <span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;R&quot;</span><span class="p">,</span> <span class="s">&quot;G&quot;</span><span class="p">,</span> <span class="s">&quot;B&quot;</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">)),</span>
    <span class="s">&quot;CMYK&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s">&quot;RGB&quot;</span><span class="p">,</span> <span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;M&quot;</span><span class="p">,</span> <span class="s">&quot;Y&quot;</span><span class="p">,</span> <span class="s">&quot;K&quot;</span><span class="p">)),</span>
    <span class="s">&quot;YCbCr&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s">&quot;RGB&quot;</span><span class="p">,</span> <span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;Y&quot;</span><span class="p">,</span> <span class="s">&quot;Cb&quot;</span><span class="p">,</span> <span class="s">&quot;Cr&quot;</span><span class="p">)),</span>

    <span class="c"># Experimental modes include I;16, I;16L, I;16B, RGBa, BGR;15, and</span>
    <span class="c"># BGR;24.  Use these modes only if you know exactly what you&#39;re</span>
    <span class="c"># doing...</span>

<span class="p">}</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">byteorder</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">struct</span>
    <span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;h&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\0\1</span><span class="s">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">byteorder</span> <span class="o">=</span> <span class="s">&quot;big&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">byteorder</span> <span class="o">=</span> <span class="s">&quot;little&quot;</span>

<span class="k">if</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="s">&#39;little&#39;</span><span class="p">:</span>
    <span class="n">_ENDIAN</span> <span class="o">=</span> <span class="s">&#39;&lt;&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">_ENDIAN</span> <span class="o">=</span> <span class="s">&#39;&gt;&#39;</span>

<span class="n">_MODE_CONV</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c"># official modes</span>
    <span class="s">&quot;1&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;|b1&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="c"># broken</span>
    <span class="s">&quot;L&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;|u1&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="s">&quot;I&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">_ENDIAN</span> <span class="o">+</span> <span class="s">&#39;i4&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="s">&quot;F&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">_ENDIAN</span> <span class="o">+</span> <span class="s">&#39;f4&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="s">&quot;P&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;|u1&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="s">&quot;RGB&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;|u1&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="s">&quot;RGBX&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;|u1&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="s">&quot;RGBA&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;|u1&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="s">&quot;CMYK&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;|u1&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="s">&quot;YCbCr&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;|u1&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">_conv_type_shape</span><span class="p">(</span><span class="n">im</span><span class="p">):</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">im</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">typ</span><span class="p">,</span> <span class="n">extra</span> <span class="o">=</span> <span class="n">_MODE_CONV</span><span class="p">[</span><span class="n">im</span><span class="o">.</span><span class="n">mode</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">extra</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">shape</span><span class="p">,</span> <span class="n">typ</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">shape</span><span class="o">+</span><span class="p">(</span><span class="n">extra</span><span class="p">,),</span> <span class="n">typ</span>


<span class="n">MODES</span> <span class="o">=</span> <span class="n">_MODEINFO</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="n">MODES</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

<span class="c"># raw modes that may be memory mapped.  NOTE: if you change this, you</span>
<span class="c"># may have to modify the stride calculation in map.c too!</span>
<span class="n">_MAPMODES</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="s">&quot;P&quot;</span><span class="p">,</span> <span class="s">&quot;RGBX&quot;</span><span class="p">,</span> <span class="s">&quot;RGBA&quot;</span><span class="p">,</span> <span class="s">&quot;CMYK&quot;</span><span class="p">,</span> <span class="s">&quot;I;16&quot;</span><span class="p">,</span> <span class="s">&quot;I;16L&quot;</span><span class="p">,</span> <span class="s">&quot;I;16B&quot;</span><span class="p">)</span>

<span class="c">##</span>
<span class="c"># Gets the &quot;base&quot; mode for given mode.  This function returns &quot;L&quot; for</span>
<span class="c"># images that contain grayscale data, and &quot;RGB&quot; for images that</span>
<span class="c"># contain color data.</span>
<span class="c">#</span>
<span class="c"># @param mode Input mode.</span>
<span class="c"># @return &quot;L&quot; or &quot;RGB&quot;.</span>
<span class="c"># @exception KeyError If the input mode was not a standard mode.</span>

<span class="k">def</span> <span class="nf">getmodebase</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ImageMode</span><span class="o">.</span><span class="n">getmode</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">basemode</span>

<span class="c">##</span>
<span class="c"># Gets the storage type mode.  Given a mode, this function returns a</span>
<span class="c"># single-layer mode suitable for storing individual bands.</span>
<span class="c">#</span>
<span class="c"># @param mode Input mode.</span>
<span class="c"># @return &quot;L&quot;, &quot;I&quot;, or &quot;F&quot;.</span>
<span class="c"># @exception KeyError If the input mode was not a standard mode.</span>

<span class="k">def</span> <span class="nf">getmodetype</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ImageMode</span><span class="o">.</span><span class="n">getmode</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">basetype</span>

<span class="c">##</span>
<span class="c"># Gets a list of individual band names.  Given a mode, this function</span>
<span class="c"># returns a tuple containing the names of individual bands (use</span>
<span class="c"># {@link #getmodetype} to get the mode used to store each individual</span>
<span class="c"># band.</span>
<span class="c">#</span>
<span class="c"># @param mode Input mode.</span>
<span class="c"># @return A tuple containing band names.  The length of the tuple</span>
<span class="c">#     gives the number of bands in an image of the given mode.</span>
<span class="c"># @exception KeyError If the input mode was not a standard mode.</span>

<span class="k">def</span> <span class="nf">getmodebandnames</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ImageMode</span><span class="o">.</span><span class="n">getmode</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">bands</span>

<span class="c">##</span>
<span class="c"># Gets the number of individual bands for this mode.</span>
<span class="c">#</span>
<span class="c"># @param mode Input mode.</span>
<span class="c"># @return The number of bands in this mode.</span>
<span class="c"># @exception KeyError If the input mode was not a standard mode.</span>

<span class="k">def</span> <span class="nf">getmodebands</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">ImageMode</span><span class="o">.</span><span class="n">getmode</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">bands</span><span class="p">)</span>

<span class="c"># --------------------------------------------------------------------</span>
<span class="c"># Helpers</span>

<span class="n">_initialized</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c">##</span>
<span class="c"># Explicitly loads standard file format drivers.</span>

<div class="viewcode-block" id="preinit"><a class="viewcode-back" href="../../index.html#PIL.Image.preinit">[docs]</a><span class="k">def</span> <span class="nf">preinit</span><span class="p">():</span>
    <span class="s">&quot;Load standard file format drivers.&quot;</span>

    <span class="k">global</span> <span class="n">_initialized</span>
    <span class="k">if</span> <span class="n">_initialized</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">BmpImagePlugin</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">GifImagePlugin</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">JpegImagePlugin</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">PpmImagePlugin</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">PngImagePlugin</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">pass</span>
<span class="c">#   try:</span>
<span class="c">#       import TiffImagePlugin</span>
<span class="c">#   except ImportError:</span>
<span class="c">#       pass</span>

    <span class="n">_initialized</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c">##</span>
<span class="c"># Explicitly initializes the Python Imaging Library.  This function</span>
<span class="c"># loads all available file format drivers.</span>
</div>
<div class="viewcode-block" id="init"><a class="viewcode-back" href="../../index.html#PIL.Image.init">[docs]</a><span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
    <span class="s">&quot;Load all file format drivers.&quot;</span>

    <span class="k">global</span> <span class="n">_initialized</span>
    <span class="k">if</span> <span class="n">_initialized</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="n">visited</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">directories</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">directories</span> <span class="o">=</span> <span class="n">directories</span> <span class="o">+</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)]</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c"># only check directories (including current, if present in the path)</span>
    <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="n">isDirectory</span><span class="p">,</span> <span class="n">directories</span><span class="p">):</span>
        <span class="n">fullpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">visited</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">fullpath</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">file</span><span class="p">[</span><span class="o">-</span><span class="mi">14</span><span class="p">:]</span> <span class="o">==</span> <span class="s">&quot;ImagePlugin.py&quot;</span><span class="p">:</span>
                <span class="n">f</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">__import__</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="p">[])</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&quot;Image: failed to import&quot;</span><span class="p">,</span>
                        <span class="k">print</span> <span class="n">f</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_value</span>
        <span class="n">visited</span><span class="p">[</span><span class="n">fullpath</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">OPEN</span> <span class="ow">or</span> <span class="n">SAVE</span><span class="p">:</span>
        <span class="n">_initialized</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="mi">1</span>

<span class="c"># --------------------------------------------------------------------</span>
<span class="c"># Codec factories (used by tostring/fromstring and ImageFile.load)</span>
</div>
<span class="k">def</span> <span class="nf">_getdecoder</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">decoder_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">()):</span>

    <span class="c"># tweak arguments</span>
    <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">isTupleType</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="p">,)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c"># get decoder</span>
        <span class="n">decoder</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">decoder_name</span> <span class="o">+</span> <span class="s">&quot;_decoder&quot;</span><span class="p">)</span>
        <span class="c"># print decoder, (mode,) + args + extra</span>
        <span class="k">return</span> <span class="nb">apply</span><span class="p">(</span><span class="n">decoder</span><span class="p">,</span> <span class="p">(</span><span class="n">mode</span><span class="p">,)</span> <span class="o">+</span> <span class="n">args</span> <span class="o">+</span> <span class="n">extra</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;decoder </span><span class="si">%s</span><span class="s"> not available&quot;</span> <span class="o">%</span> <span class="n">decoder_name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_getencoder</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">encoder_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">()):</span>

    <span class="c"># tweak arguments</span>
    <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">isTupleType</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="p">,)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c"># get encoder</span>
        <span class="n">encoder</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">encoder_name</span> <span class="o">+</span> <span class="s">&quot;_encoder&quot;</span><span class="p">)</span>
        <span class="c"># print encoder, (mode,) + args + extra</span>
        <span class="k">return</span> <span class="nb">apply</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="p">(</span><span class="n">mode</span><span class="p">,)</span> <span class="o">+</span> <span class="n">args</span> <span class="o">+</span> <span class="n">extra</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;encoder </span><span class="si">%s</span><span class="s"> not available&quot;</span> <span class="o">%</span> <span class="n">encoder_name</span><span class="p">)</span>


<span class="c"># --------------------------------------------------------------------</span>
<span class="c"># Simple expression analyzer</span>

<span class="k">class</span> <span class="nc">_E</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">def</span> <span class="nf">__coerce__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="p">,</span> <span class="n">_E</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="n">_E</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;__add__&quot;</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="n">_E</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;__mul__&quot;</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_getscaleoffset</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="n">stub</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;stub&quot;</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">expr</span><span class="p">(</span><span class="n">_E</span><span class="p">(</span><span class="n">stub</span><span class="p">))</span><span class="o">.</span><span class="n">data</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">=</span> <span class="n">data</span> <span class="c"># simplified syntax</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="ow">is</span> <span class="n">stub</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">==</span> <span class="s">&quot;__mul__&quot;</span> <span class="ow">and</span> <span class="n">isNumberType</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="ow">is</span> <span class="n">stub</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">==</span> <span class="s">&quot;__add__&quot;</span> <span class="ow">and</span> <span class="n">isNumberType</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
            <span class="k">return</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">c</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="o">=</span> <span class="n">data</span> <span class="c"># full syntax</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="ow">is</span> <span class="n">stub</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">==</span> <span class="s">&quot;__mul__&quot;</span> <span class="ow">and</span> <span class="n">isNumberType</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">d</span> <span class="o">==</span> <span class="s">&quot;__add__&quot;</span> <span class="ow">and</span> <span class="n">isNumberType</span><span class="p">(</span><span class="n">e</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">e</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;illegal expression&quot;</span><span class="p">)</span>


<span class="c"># --------------------------------------------------------------------</span>
<span class="c"># Implementation wrapper</span>

<span class="c">##</span>
<span class="c"># This class represents an image object.  To create Image objects, use</span>
<span class="c"># the appropriate factory functions.  There&#39;s hardly ever any reason</span>
<span class="c"># to call the Image constructor directly.</span>
<span class="c">#</span>
<span class="c"># @see #open</span>
<span class="c"># @see #new</span>
<span class="c"># @see #fromstring</span>

<span class="k">class</span> <span class="nc">Image</span><span class="p">:</span>

    <span class="n">format</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">format_description</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># FIXME: take &quot;new&quot; parameters / other image?</span>
        <span class="c"># FIXME: turn mode and size into delegating properties?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">palette</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">NORMAL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">):</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">Image</span><span class="p">()</span>
        <span class="n">new</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="n">im</span>
        <span class="n">new</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">mode</span>
        <span class="n">new</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">size</span>
        <span class="n">new</span><span class="o">.</span><span class="n">palette</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">palette</span>
        <span class="k">if</span> <span class="n">im</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;P&quot;</span><span class="p">:</span>
            <span class="n">new</span><span class="o">.</span><span class="n">palette</span> <span class="o">=</span> <span class="n">ImagePalette</span><span class="o">.</span><span class="n">ImagePalette</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c"># fallback (pre-1.5.2)</span>
            <span class="n">new</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
                <span class="n">new</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="n">_makeself</span> <span class="o">=</span> <span class="n">_new</span> <span class="c"># compatibility</span>

    <span class="k">def</span> <span class="nf">_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">file</span><span class="p">:</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mktemp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">format</span> <span class="ow">or</span> <span class="n">format</span> <span class="o">==</span> <span class="s">&quot;PPM&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">save_ppm</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="nb">file</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">format</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">format</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">file</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s"> image mode=</span><span class="si">%s</span><span class="s"> size=</span><span class="si">%d</span><span class="s">x</span><span class="si">%d</span><span class="s"> at 0x</span><span class="si">%X</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__module__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&quot;__array_interface__&quot;</span><span class="p">:</span>
            <span class="c"># numpy array interface support</span>
            <span class="n">new</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">shape</span><span class="p">,</span> <span class="n">typestr</span> <span class="o">=</span> <span class="n">_conv_type_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">new</span><span class="p">[</span><span class="s">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shape</span>
            <span class="n">new</span><span class="p">[</span><span class="s">&#39;typestr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">typestr</span>
            <span class="n">new</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">new</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Returns a string containing pixel data.</span>
    <span class="c">#</span>
    <span class="c"># @param encoder_name What encoder to use.  The default is to</span>
    <span class="c">#    use the standard &quot;raw&quot; encoder.</span>
    <span class="c"># @param *args Extra arguments to the encoder.</span>
    <span class="c"># @return An 8-bit string.</span>

    <span class="k">def</span> <span class="nf">tostring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder_name</span><span class="o">=</span><span class="s">&quot;raw&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="s">&quot;Return image as a binary string&quot;</span>

        <span class="c"># may pass tuple instead of argument list</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">isTupleType</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">encoder_name</span> <span class="o">==</span> <span class="s">&quot;raw&quot;</span> <span class="ow">and</span> <span class="n">args</span> <span class="o">==</span> <span class="p">():</span>
            <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="c"># unpack data</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">_getencoder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">encoder_name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">e</span><span class="o">.</span><span class="n">setimage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">)</span>

        <span class="n">bufsize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">65536</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="c"># see RawEncode.c</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">l</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">bufsize</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;encoder error </span><span class="si">%d</span><span class="s"> in tostring&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Returns the image converted to an X11 bitmap.  This method</span>
    <span class="c"># only works for mode &quot;1&quot; images.</span>
    <span class="c">#</span>
    <span class="c"># @param name The name prefix to use for the bitmap variables.</span>
    <span class="c"># @return A string containing an X11 bitmap.</span>
    <span class="c"># @exception ValueError If the mode is not &quot;1&quot;</span>

    <span class="k">def</span> <span class="nf">tobitmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;image&quot;</span><span class="p">):</span>
        <span class="s">&quot;Return image as an XBM bitmap&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s">&quot;1&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;not a bitmap&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="s">&quot;xbm&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;#define </span><span class="si">%s</span><span class="s">_width </span><span class="si">%d</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s">&quot;#define </span><span class="si">%s</span><span class="s">_height </span><span class="si">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s">&quot;static char </span><span class="si">%s</span><span class="s">_bits[] = {</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="s">&quot;};&quot;</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Loads this image with pixel data from a string.</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># This method is similar to the {@link #fromstring} function, but</span>
    <span class="c"># loads data into this image instead of creating a new image</span>
    <span class="c"># object.</span>

    <span class="k">def</span> <span class="nf">fromstring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">decoder_name</span><span class="o">=</span><span class="s">&quot;raw&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="s">&quot;Load data to image from binary string&quot;</span>

        <span class="c"># may pass tuple instead of argument list</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">isTupleType</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c"># default format</span>
        <span class="k">if</span> <span class="n">decoder_name</span> <span class="o">==</span> <span class="s">&quot;raw&quot;</span> <span class="ow">and</span> <span class="n">args</span> <span class="o">==</span> <span class="p">():</span>
            <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span>

        <span class="c"># unpack data</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">_getdecoder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">decoder_name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">setimage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;not enough image data&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;cannot decode image data&quot;</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Allocates storage for the image and loads the pixel data.  In</span>
    <span class="c"># normal cases, you don&#39;t need to call this method, since the</span>
    <span class="c"># Image class automatically loads an opened image when it is</span>
    <span class="c"># accessed for the first time.</span>
    <span class="c">#</span>
    <span class="c"># @return An image access object.</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Explicitly load pixel data.&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">palette</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">palette</span><span class="o">.</span><span class="n">dirty</span><span class="p">:</span>
            <span class="c"># realize palette</span>
            <span class="nb">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">putpalette</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">palette</span><span class="o">.</span><span class="n">getdata</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">palette</span><span class="o">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">palette</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s">&quot;RGB&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">palette</span><span class="o">.</span><span class="n">rawmode</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;transparency&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">putpalettealpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s">&quot;transparency&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">palette</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s">&quot;RGBA&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">pixel_access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Verifies the contents of a file. For data read from a file, this</span>
    <span class="c"># method attempts to determine if the file is broken, without</span>
    <span class="c"># actually decoding the image data.  If this method finds any</span>
    <span class="c"># problems, it raises suitable exceptions.  If you need to load</span>
    <span class="c"># the image after using this method, you must reopen the image</span>
    <span class="c"># file.</span>

    <span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Verify file contents.&quot;</span>
        <span class="k">pass</span>

    <span class="c">##</span>
    <span class="c"># Returns a converted copy of this image. For the &quot;P&quot; mode, this</span>
    <span class="c"># method translates pixels through the palette.  If mode is</span>
    <span class="c"># omitted, a mode is chosen so that all information in the image</span>
    <span class="c"># and the palette can be represented without a palette.</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># The current version supports all possible conversions between</span>
    <span class="c"># &quot;L&quot;, &quot;RGB&quot; and &quot;CMYK.&quot;</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># When translating a colour image to black and white (mode &quot;L&quot;),</span>
    <span class="c"># the library uses the ITU-R 601-2 luma transform:</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># &lt;b&gt;L = R * 299/1000 + G * 587/1000 + B * 114/1000&lt;/b&gt;</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># When translating a greyscale image into a bilevel image (mode</span>
    <span class="c"># &quot;1&quot;), all non-zero values are set to 255 (white). To use other</span>
    <span class="c"># thresholds, use the {@link #Image.point} method.</span>
    <span class="c">#</span>
    <span class="c"># @def convert(mode, matrix=None, **options)</span>
    <span class="c"># @param mode The requested mode.</span>
    <span class="c"># @param matrix An optional conversion matrix.  If given, this</span>
    <span class="c">#    should be 4- or 16-tuple containing floating point values.</span>
    <span class="c"># @param options Additional options, given as keyword arguments.</span>
    <span class="c"># @keyparam dither Dithering method, used when converting from</span>
    <span class="c">#    mode &quot;RGB&quot; to &quot;P&quot;.</span>
    <span class="c">#    Available methods are NONE or FLOYDSTEINBERG (default).</span>
    <span class="c"># @keyparam palette Palette to use when converting from mode &quot;RGB&quot;</span>
    <span class="c">#    to &quot;P&quot;.  Available palettes are WEB or ADAPTIVE.</span>
    <span class="c"># @keyparam colors Number of colors to use for the ADAPTIVE palette.</span>
    <span class="c">#    Defaults to 256.</span>
    <span class="c"># @return An Image object.</span>

    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dither</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">palette</span><span class="o">=</span><span class="n">WEB</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="s">&quot;Convert to other pixel format&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">mode</span><span class="p">:</span>
            <span class="c"># determine default mode</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;P&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">palette</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">palette</span><span class="o">.</span><span class="n">mode</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="s">&quot;RGB&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="c"># matrix conversion</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="s">&quot;RGB&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;illegal conversion&quot;</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">convert_matrix</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;P&quot;</span> <span class="ow">and</span> <span class="n">palette</span> <span class="o">==</span> <span class="n">ADAPTIVE</span><span class="p">:</span>
            <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

        <span class="c"># colourspace conversion</span>
        <span class="k">if</span> <span class="n">dither</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dither</span> <span class="o">=</span> <span class="n">FLOYDSTEINBERG</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">dither</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># normalize source image and try again</span>
                <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">getmodebase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">))</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">dither</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;illegal conversion&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">quantize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">kmeans</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="c"># methods:</span>
        <span class="c">#    0 = median cut</span>
        <span class="c">#    1 = maximum coverage</span>

        <span class="c"># NOTE: this functionality will be moved to the extended</span>
        <span class="c"># quantizer interface in a later version of PIL.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">palette</span><span class="p">:</span>
            <span class="c"># use palette from reference image</span>
            <span class="n">palette</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">palette</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s">&quot;P&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;bad mode for palette image&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s">&quot;RGB&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s">&quot;L&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s">&quot;only RGB or L mode images can be quantized to a palette&quot;</span>
                    <span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s">&quot;P&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">palette</span><span class="o">.</span><span class="n">im</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makeself</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">kmeans</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Copies this image. Use this method if you wish to paste things</span>
    <span class="c"># into an image, but still retain the original.</span>
    <span class="c">#</span>
    <span class="c"># @return An Image object.</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Copy raster data&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Returns a rectangular region from this image. The box is a</span>
    <span class="c"># 4-tuple defining the left, upper, right, and lower pixel</span>
    <span class="c"># coordinate.</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># This is a lazy operation.  Changes to the source image may or</span>
    <span class="c"># may not be reflected in the cropped image.  To break the</span>
    <span class="c"># connection, call the {@link #Image.load} method on the cropped</span>
    <span class="c"># copy.</span>
    <span class="c">#</span>
    <span class="c"># @param The crop rectangle, as a (left, upper, right, lower)-tuple.</span>
    <span class="c"># @return An Image object.</span>

    <span class="k">def</span> <span class="nf">crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">&quot;Crop region from image&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c"># lazy operation</span>
        <span class="k">return</span> <span class="n">_ImageCrop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Configures the image file loader so it returns a version of the</span>
    <span class="c"># image that as closely as possible matches the given mode and</span>
    <span class="c"># size.  For example, you can use this method to convert a colour</span>
    <span class="c"># JPEG to greyscale while loading it, or to extract a 128x192</span>
    <span class="c"># version from a PCD file.</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># Note that this method modifies the Image object in place.  If</span>
    <span class="c"># the image has already been loaded, this method has no effect.</span>
    <span class="c">#</span>
    <span class="c"># @param mode The requested mode.</span>
    <span class="c"># @param size The requested size.</span>

    <span class="k">def</span> <span class="nf">draft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="s">&quot;Configure image decoder&quot;</span>

        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmargin</span><span class="p">,</span> <span class="n">ymargin</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ymargin</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ymargin</span> <span class="o">=</span> <span class="n">xmargin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">xmargin</span><span class="p">,</span> <span class="n">ymargin</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="c">##</span>
    <span class="c"># Filters this image using the given filter.  For a list of</span>
    <span class="c"># available filters, see the &lt;b&gt;ImageFilter&lt;/b&gt; module.</span>
    <span class="c">#</span>
    <span class="c"># @param filter Filter kernel.</span>
    <span class="c"># @return An Image object.</span>
    <span class="c"># @see ImageFilter</span>

    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">):</span>
        <span class="s">&quot;Apply environment filter to image&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">filter</span><span class="p">):</span>
            <span class="nb">filter</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="s">&quot;filter&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;filter argument should be ImageFilter.Filter instance or class&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">bands</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="nb">filter</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">))</span>
        <span class="c"># fix to handle multiband images since _imaging doesn&#39;t</span>
        <span class="n">ims</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">bands</span><span class="p">):</span>
            <span class="n">ims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="nb">filter</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">getband</span><span class="p">(</span><span class="n">c</span><span class="p">))))</span>
        <span class="k">return</span> <span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">ims</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Returns a tuple containing the name of each band in this image.</span>
    <span class="c"># For example, &lt;b&gt;getbands&lt;/b&gt; on an RGB image returns (&quot;R&quot;, &quot;G&quot;, &quot;B&quot;).</span>
    <span class="c">#</span>
    <span class="c"># @return A tuple containing band names.</span>

    <span class="k">def</span> <span class="nf">getbands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Get band names&quot;</span>

        <span class="k">return</span> <span class="n">ImageMode</span><span class="o">.</span><span class="n">getmode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">bands</span>

    <span class="c">##</span>
    <span class="c"># Calculates the bounding box of the non-zero regions in the</span>
    <span class="c"># image.</span>
    <span class="c">#</span>
    <span class="c"># @return The bounding box is returned as a 4-tuple defining the</span>
    <span class="c">#    left, upper, right, and lower pixel coordinate. If the image</span>
    <span class="c">#    is completely empty, this method returns None.</span>

    <span class="k">def</span> <span class="nf">getbbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Get bounding box of actual data (non-zero pixels) in image&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">getbbox</span><span class="p">()</span>

    <span class="c">##</span>
    <span class="c"># Returns a list of colors used in this image.</span>
    <span class="c">#</span>
    <span class="c"># @param maxcolors Maximum number of colors.  If this number is</span>
    <span class="c">#    exceeded, this method returns None.  The default limit is</span>
    <span class="c">#    256 colors.</span>
    <span class="c"># @return An unsorted list of (count, pixel) values.</span>

    <span class="k">def</span> <span class="nf">getcolors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxcolors</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="s">&quot;Get colors from image, up to given limit&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="s">&quot;P&quot;</span><span class="p">):</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">histogram</span><span class="p">()</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxcolors</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">getcolors</span><span class="p">(</span><span class="n">maxcolors</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Returns the contents of this image as a sequence object</span>
    <span class="c"># containing pixel values.  The sequence object is flattened, so</span>
    <span class="c"># that values for line one follow directly after the values of</span>
    <span class="c"># line zero, and so on.</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># Note that the sequence object returned by this method is an</span>
    <span class="c"># internal PIL data type, which only supports certain sequence</span>
    <span class="c"># operations.  To convert it to an ordinary sequence (e.g. for</span>
    <span class="c"># printing), use &lt;b&gt;list(im.getdata())&lt;/b&gt;.</span>
    <span class="c">#</span>
    <span class="c"># @param band What band to return.  The default is to return</span>
    <span class="c">#    all bands.  To return a single band, pass in the index</span>
    <span class="c">#    value (e.g. 0 to get the &quot;R&quot; band from an &quot;RGB&quot; image).</span>
    <span class="c"># @return A sequence-like object.</span>

    <span class="k">def</span> <span class="nf">getdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">band</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="s">&quot;Get image data as sequence object.&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">getband</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="c"># could be abused</span>

    <span class="c">##</span>
    <span class="c"># Gets the the minimum and maximum pixel values for each band in</span>
    <span class="c"># the image.</span>
    <span class="c">#</span>
    <span class="c"># @return For a single-band image, a 2-tuple containing the</span>
    <span class="c">#    minimum and maximum pixel value.  For a multi-band image,</span>
    <span class="c">#    a tuple containing one 2-tuple for each band.</span>

    <span class="k">def</span> <span class="nf">getextrema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Get min/max value&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">bands</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">extrema</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">bands</span><span class="p">):</span>
                <span class="n">extrema</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">getband</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">getextrema</span><span class="p">())</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">extrema</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">getextrema</span><span class="p">()</span>

    <span class="c">##</span>
    <span class="c"># Returns a PyCObject that points to the internal image memory.</span>
    <span class="c">#</span>
    <span class="c"># @return A PyCObject object.</span>

    <span class="k">def</span> <span class="nf">getim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Get PyCObject pointer to internal image memory&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">ptr</span>


    <span class="c">##</span>
    <span class="c"># Returns the image palette as a list.</span>
    <span class="c">#</span>
    <span class="c"># @return A list of color values [r, g, b, ...], or None if the</span>
    <span class="c">#    image has no palette.</span>

    <span class="k">def</span> <span class="nf">getpalette</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Get palette contents.&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="nb">ord</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">getpalette</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span> <span class="c"># no palette</span>


    <span class="c">##</span>
    <span class="c"># Returns the pixel value at a given position.</span>
    <span class="c">#</span>
    <span class="c"># @param xy The coordinate, given as (x, y).</span>
    <span class="c"># @return The pixel value.  If the image is a multi-layer image,</span>
    <span class="c">#    this method returns a tuple.</span>

    <span class="k">def</span> <span class="nf">getpixel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xy</span><span class="p">):</span>
        <span class="s">&quot;Get pixel value&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">getpixel</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Returns the horizontal and vertical projection.</span>
    <span class="c">#</span>
    <span class="c"># @return Two sequences, indicating where there are non-zero</span>
    <span class="c">#     pixels along the X-axis and the Y-axis, respectively.</span>

    <span class="k">def</span> <span class="nf">getprojection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Get projection to x and y axes&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">getprojection</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="nb">ord</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="nb">map</span><span class="p">(</span><span class="nb">ord</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Returns a histogram for the image. The histogram is returned as</span>
    <span class="c"># a list of pixel counts, one for each pixel value in the source</span>
    <span class="c"># image. If the image has more than one band, the histograms for</span>
    <span class="c"># all bands are concatenated (for example, the histogram for an</span>
    <span class="c"># &quot;RGB&quot; image contains 768 values).</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># A bilevel image (mode &quot;1&quot;) is treated as a greyscale (&quot;L&quot;) image</span>
    <span class="c"># by this method.</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># If a mask is provided, the method returns a histogram for those</span>
    <span class="c"># parts of the image where the mask image is non-zero. The mask</span>
    <span class="c"># image must have the same size as the image, and be either a</span>
    <span class="c"># bi-level image (mode &quot;1&quot;) or a greyscale image (&quot;L&quot;).</span>
    <span class="c">#</span>
    <span class="c"># @def histogram(mask=None)</span>
    <span class="c"># @param mask An optional mask.</span>
    <span class="c"># @return A list containing pixel counts.</span>

    <span class="k">def</span> <span class="nf">histogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">extrema</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">&quot;Take histogram of image&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">mask</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">histogram</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">mask</span><span class="o">.</span><span class="n">im</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;I&quot;</span><span class="p">,</span> <span class="s">&quot;F&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">extrema</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">extrema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getextrema</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">extrema</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">histogram</span><span class="p">()</span>

    <span class="c">##</span>
    <span class="c"># (Deprecated) Returns a copy of the image where the data has been</span>
    <span class="c"># offset by the given distances. Data wraps around the edges. If</span>
    <span class="c"># yoffset is omitted, it is assumed to be equal to xoffset.</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># This method is deprecated. New code should use the &lt;b&gt;offset&lt;/b&gt;</span>
    <span class="c"># function in the &lt;b&gt;ImageChops&lt;/b&gt; module.</span>
    <span class="c">#</span>
    <span class="c"># @param xoffset The horizontal distance.</span>
    <span class="c"># @param yoffset The vertical distance.  If omitted, both</span>
    <span class="c">#    distances are set to the same value.</span>
    <span class="c"># @return An Image object.</span>

    <span class="k">def</span> <span class="nf">offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xoffset</span><span class="p">,</span> <span class="n">yoffset</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">&quot;(deprecated) Offset image in horizontal and/or vertical direction&quot;</span>
        <span class="k">if</span> <span class="n">warnings</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s">&quot;&#39;offset&#39; is deprecated; use &#39;ImageChops.offset&#39; instead&quot;</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
                <span class="p">)</span>
        <span class="kn">import</span> <span class="nn">ImageChops</span>
        <span class="k">return</span> <span class="n">ImageChops</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xoffset</span><span class="p">,</span> <span class="n">yoffset</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Pastes another image into this image. The box argument is either</span>
    <span class="c"># a 2-tuple giving the upper left corner, a 4-tuple defining the</span>
    <span class="c"># left, upper, right, and lower pixel coordinate, or None (same as</span>
    <span class="c"># (0, 0)).  If a 4-tuple is given, the size of the pasted image</span>
    <span class="c"># must match the size of the region.</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># If the modes don&#39;t match, the pasted image is converted to the</span>
    <span class="c"># mode of this image (see the {@link #Image.convert} method for</span>
    <span class="c"># details).</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># Instead of an image, the source can be a integer or tuple</span>
    <span class="c"># containing pixel values.  The method then fills the region</span>
    <span class="c"># with the given colour.  When creating RGB images, you can</span>
    <span class="c"># also use colour strings as supported by the ImageColor module.</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># If a mask is given, this method updates only the regions</span>
    <span class="c"># indicated by the mask.  You can use either &quot;1&quot;, &quot;L&quot; or &quot;RGBA&quot;</span>
    <span class="c"># images (in the latter case, the alpha band is used as mask).</span>
    <span class="c"># Where the mask is 255, the given image is copied as is.  Where</span>
    <span class="c"># the mask is 0, the current value is preserved.  Intermediate</span>
    <span class="c"># values can be used for transparency effects.</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># Note that if you paste an &quot;RGBA&quot; image, the alpha band is</span>
    <span class="c"># ignored.  You can work around this by using the same image as</span>
    <span class="c"># both source image and mask.</span>
    <span class="c">#</span>
    <span class="c"># @param im Source image or pixel value (integer or tuple).</span>
    <span class="c"># @param box An optional 4-tuple giving the region to paste into.</span>
    <span class="c">#    If a 2-tuple is used instead, it&#39;s treated as the upper left</span>
    <span class="c">#    corner.  If omitted or None, the source is pasted into the</span>
    <span class="c">#    upper left corner.</span>
    <span class="c">#    &lt;p&gt;</span>
    <span class="c">#    If an image is given as the second argument and there is no</span>
    <span class="c">#    third, the box defaults to (0, 0), and the second argument</span>
    <span class="c">#    is interpreted as a mask image.</span>
    <span class="c"># @param mask An optional mask image.</span>
    <span class="c"># @return An Image object.</span>

    <span class="k">def</span> <span class="nf">paste</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">&quot;Paste other image into region&quot;</span>

        <span class="k">if</span> <span class="n">isImageType</span><span class="p">(</span><span class="n">box</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mask</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># abbreviated paste(im, mask) syntax</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">box</span><span class="p">;</span> <span class="n">box</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># cover all of self</span>
            <span class="n">box</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">box</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c"># lower left corner given; get size from image or mask</span>
            <span class="k">if</span> <span class="n">isImageType</span><span class="p">(</span><span class="n">im</span><span class="p">):</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">size</span>
            <span class="k">elif</span> <span class="n">isImageType</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># FIXME: use self.size here?</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s">&quot;cannot determine region size; use 4-item box&quot;</span>
                    <span class="p">)</span>
            <span class="n">box</span> <span class="o">=</span> <span class="n">box</span> <span class="o">+</span> <span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">isStringType</span><span class="p">(</span><span class="n">im</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">ImageColor</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">ImageColor</span><span class="o">.</span><span class="n">getcolor</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">isImageType</span><span class="p">(</span><span class="n">im</span><span class="p">):</span>
            <span class="n">im</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">im</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s">&quot;RGB&quot;</span> <span class="ow">or</span> <span class="n">im</span><span class="o">.</span><span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;RGBA&quot;</span><span class="p">,</span> <span class="s">&quot;RGBa&quot;</span><span class="p">):</span>
                    <span class="c"># should use an adapter for this!</span>
                    <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">im</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">mask</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">im</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">box</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Maps this image through a lookup table or function.</span>
    <span class="c">#</span>
    <span class="c"># @param lut A lookup table, containing 256 values per band in the</span>
    <span class="c">#    image. A function can be used instead, it should take a single</span>
    <span class="c">#    argument. The function is called once for each possible pixel</span>
    <span class="c">#    value, and the resulting table is applied to all bands of the</span>
    <span class="c">#    image.</span>
    <span class="c"># @param mode Output mode (default is same as input).  In the</span>
    <span class="c">#    current version, this can only be used if the source image</span>
    <span class="c">#    has mode &quot;L&quot; or &quot;P&quot;, and the output has mode &quot;1&quot;.</span>
    <span class="c"># @return An Image object.</span>

    <span class="k">def</span> <span class="nf">point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lut</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">&quot;Map image through lookup table&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lut</span><span class="p">,</span> <span class="n">ImagePointHandler</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">lut</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isSequenceType</span><span class="p">(</span><span class="n">lut</span><span class="p">):</span>
            <span class="c"># if it isn&#39;t a list, it should be a function</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;I&quot;</span><span class="p">,</span> <span class="s">&quot;I;16&quot;</span><span class="p">,</span> <span class="s">&quot;F&quot;</span><span class="p">):</span>
                <span class="c"># check if the function can be used with point_transform</span>
                <span class="n">scale</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">_getscaleoffset</span><span class="p">(</span><span class="n">lut</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">point_transform</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span>
            <span class="c"># for other modes, convert the function to a table</span>
            <span class="n">lut</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">lut</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">bands</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;F&quot;</span><span class="p">:</span>
            <span class="c"># FIXME: _imaging returns a confusing error message for this case</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;point operation not supported for this mode&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">lut</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>

    <span class="c">##</span>
    <span class="c"># Adds or replaces the alpha layer in this image.  If the image</span>
    <span class="c"># does not have an alpha layer, it&#39;s converted to &quot;LA&quot; or &quot;RGBA&quot;.</span>
    <span class="c"># The new layer must be either &quot;L&quot; or &quot;1&quot;.</span>
    <span class="c">#</span>
    <span class="c"># @param im The new alpha layer.  This can either be an &quot;L&quot; or &quot;1&quot;</span>
    <span class="c">#    image having the same size as this image, or an integer or</span>
    <span class="c">#    other color value.</span>

    <span class="k">def</span> <span class="nf">putalpha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
        <span class="s">&quot;Set alpha layer&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;LA&quot;</span><span class="p">,</span> <span class="s">&quot;RGBA&quot;</span><span class="p">):</span>
            <span class="c"># attempt to promote self to a matching alpha mode</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="n">getmodebase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;A&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">setmode</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="c"># do things the hard way</span>
                    <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">im</span><span class="o">.</span><span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;LA&quot;</span><span class="p">,</span> <span class="s">&quot;RGBA&quot;</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span> <span class="c"># sanity check</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="n">im</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">mode</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;illegal image mode&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;LA&quot;</span><span class="p">:</span>
            <span class="n">band</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">band</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="k">if</span> <span class="n">isImageType</span><span class="p">(</span><span class="n">alpha</span><span class="p">):</span>
            <span class="c"># alpha layer</span>
            <span class="k">if</span> <span class="n">alpha</span><span class="o">.</span><span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="s">&quot;L&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;illegal image mode&quot;</span><span class="p">)</span>
            <span class="n">alpha</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">alpha</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;1&quot;</span><span class="p">:</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s">&quot;L&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># constant alpha</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">fillband</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="c"># do things the hard way</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">putband</span><span class="p">(</span><span class="n">alpha</span><span class="o">.</span><span class="n">im</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Copies pixel data to this image.  This method copies data from a</span>
    <span class="c"># sequence object into the image, starting at the upper left</span>
    <span class="c"># corner (0, 0), and continuing until either the image or the</span>
    <span class="c"># sequence ends.  The scale and offset values are used to adjust</span>
    <span class="c"># the sequence values: &lt;b&gt;pixel = value*scale + offset&lt;/b&gt;.</span>
    <span class="c">#</span>
    <span class="c"># @param data A sequence object.</span>
    <span class="c"># @param scale An optional scale value.  The default is 1.0.</span>
    <span class="c"># @param offset An optional offset value.  The default is 0.0.</span>

    <span class="k">def</span> <span class="nf">putdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="s">&quot;Put data from a sequence object into an image.&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_copy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">putdata</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Attaches a palette to this image.  The image must be a &quot;P&quot; or</span>
    <span class="c"># &quot;L&quot; image, and the palette sequence must contain 768 integer</span>
    <span class="c"># values, where each group of three values represent the red,</span>
    <span class="c"># green, and blue values for the corresponding pixel</span>
    <span class="c"># index. Instead of an integer sequence, you can use an 8-bit</span>
    <span class="c"># string.</span>
    <span class="c">#</span>
    <span class="c"># @def putpalette(data)</span>
    <span class="c"># @param data A palette sequence (either a list or a string).</span>

    <span class="k">def</span> <span class="nf">putpalette</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">rawmode</span><span class="o">=</span><span class="s">&quot;RGB&quot;</span><span class="p">):</span>
        <span class="s">&quot;Put palette data into an image.&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="s">&quot;P&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;illegal image mode&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ImagePalette</span><span class="o">.</span><span class="n">ImagePalette</span><span class="p">):</span>
            <span class="n">palette</span> <span class="o">=</span> <span class="n">ImagePalette</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">rawmode</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">palette</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isStringType</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">chr</span><span class="p">,</span> <span class="n">data</span><span class="p">),</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="n">palette</span> <span class="o">=</span> <span class="n">ImagePalette</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">rawmode</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s">&quot;P&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">palette</span> <span class="o">=</span> <span class="n">palette</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">palette</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s">&quot;RGB&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span> <span class="c"># install new palette</span>

    <span class="c">##</span>
    <span class="c"># Modifies the pixel at the given position. The colour is given as</span>
    <span class="c"># a single numerical value for single-band images, and a tuple for</span>
    <span class="c"># multi-band images.</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># Note that this method is relatively slow.  For more extensive</span>
    <span class="c"># changes, use {@link #Image.paste} or the &lt;b&gt;ImageDraw&lt;/b&gt; module</span>
    <span class="c"># instead.</span>
    <span class="c">#</span>
    <span class="c"># @param xy The pixel coordinate, given as (x, y).</span>
    <span class="c"># @param value The pixel value.</span>
    <span class="c"># @see #Image.paste</span>
    <span class="c"># @see #Image.putdata</span>
    <span class="c"># @see ImageDraw</span>

    <span class="k">def</span> <span class="nf">putpixel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xy</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="s">&quot;Set pixel value&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_copy</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">putpixel</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Returns a resized copy of this image.</span>
    <span class="c">#</span>
    <span class="c"># @def resize(size, filter=NEAREST)</span>
    <span class="c"># @param size The requested size in pixels, as a 2-tuple:</span>
    <span class="c">#    (width, height).</span>
    <span class="c"># @param filter An optional resampling filter.  This can be</span>
    <span class="c">#    one of &lt;b&gt;NEAREST&lt;/b&gt; (use nearest neighbour), &lt;b&gt;BILINEAR&lt;/b&gt;</span>
    <span class="c">#    (linear interpolation in a 2x2 environment), &lt;b&gt;BICUBIC&lt;/b&gt;</span>
    <span class="c">#    (cubic spline interpolation in a 4x4 environment), or</span>
    <span class="c">#    &lt;b&gt;ANTIALIAS&lt;/b&gt; (a high-quality downsampling filter).</span>
    <span class="c">#    If omitted, or if the image has mode &quot;1&quot; or &quot;P&quot;, it is</span>
    <span class="c">#    set &lt;b&gt;NEAREST&lt;/b&gt;.</span>
    <span class="c"># @return An Image object.</span>

    <span class="k">def</span> <span class="nf">resize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="n">NEAREST</span><span class="p">):</span>
        <span class="s">&quot;Resize image&quot;</span>

        <span class="k">if</span> <span class="n">resample</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">NEAREST</span><span class="p">,</span> <span class="n">BILINEAR</span><span class="p">,</span> <span class="n">BICUBIC</span><span class="p">,</span> <span class="n">ANTIALIAS</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;unknown resampling filter&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="s">&quot;P&quot;</span><span class="p">):</span>
            <span class="n">resample</span> <span class="o">=</span> <span class="n">NEAREST</span>

        <span class="k">if</span> <span class="n">resample</span> <span class="o">==</span> <span class="n">ANTIALIAS</span><span class="p">:</span>
            <span class="c"># requires stretch support (imToolkit &amp; PIL 1.1.3)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">stretch</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">resample</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;unsupported resampling filter&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">resample</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Returns a rotated copy of this image.  This method returns a</span>
    <span class="c"># copy of this image, rotated the given number of degrees counter</span>
    <span class="c"># clockwise around its centre.</span>
    <span class="c">#</span>
    <span class="c"># @def rotate(angle, filter=NEAREST)</span>
    <span class="c"># @param angle In degrees counter clockwise.</span>
    <span class="c"># @param filter An optional resampling filter.  This can be</span>
    <span class="c">#    one of &lt;b&gt;NEAREST&lt;/b&gt; (use nearest neighbour), &lt;b&gt;BILINEAR&lt;/b&gt;</span>
    <span class="c">#    (linear interpolation in a 2x2 environment), or &lt;b&gt;BICUBIC&lt;/b&gt;</span>
    <span class="c">#    (cubic spline interpolation in a 4x4 environment).</span>
    <span class="c">#    If omitted, or if the image has mode &quot;1&quot; or &quot;P&quot;, it is</span>
    <span class="c">#    set &lt;b&gt;NEAREST&lt;/b&gt;.</span>
    <span class="c"># @param expand Optional expansion flag.  If true, expands the output</span>
    <span class="c">#    image to make it large enough to hold the entire rotated image.</span>
    <span class="c">#    If false or omitted, make the output image the same size as the</span>
    <span class="c">#    input image.</span>
    <span class="c"># @return An Image object.</span>

    <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="n">NEAREST</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="s">&quot;Rotate image.  Angle given as degrees counter-clockwise.&quot;</span>

        <span class="k">if</span> <span class="n">expand</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">math</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="o">-</span><span class="n">angle</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="p">[</span>
                 <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="mf">0.0</span>
                 <span class="p">]</span>
            <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span><span class="o">=</span><span class="n">matrix</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">e</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="n">f</span>

            <span class="c"># calculate output size</span>
            <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">yy</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">)):</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="n">xx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">yy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">xx</span><span class="p">))</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">xx</span><span class="p">)))</span>
            <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">yy</span><span class="p">))</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">yy</span><span class="p">)))</span>

            <span class="c"># adjust center</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">h</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">x</span>
            <span class="n">matrix</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">y</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">((</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">AFFINE</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">resample</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">resample</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">NEAREST</span><span class="p">,</span> <span class="n">BILINEAR</span><span class="p">,</span> <span class="n">BICUBIC</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;unknown resampling filter&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="s">&quot;P&quot;</span><span class="p">):</span>
            <span class="n">resample</span> <span class="o">=</span> <span class="n">NEAREST</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">resample</span><span class="p">))</span>

    <span class="c">##</span>
    <span class="c"># Saves this image under the given filename.  If no format is</span>
    <span class="c"># specified, the format to use is determined from the filename</span>
    <span class="c"># extension, if possible.</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># Keyword options can be used to provide additional instructions</span>
    <span class="c"># to the writer. If a writer doesn&#39;t recognise an option, it is</span>
    <span class="c"># silently ignored. The available options are described later in</span>
    <span class="c"># this handbook.</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># You can use a file object instead of a filename. In this case,</span>
    <span class="c"># you must always specify the format. The file object must</span>
    <span class="c"># implement the &lt;b&gt;seek&lt;/b&gt;, &lt;b&gt;tell&lt;/b&gt;, and &lt;b&gt;write&lt;/b&gt;</span>
    <span class="c"># methods, and be opened in binary mode.</span>
    <span class="c">#</span>
    <span class="c"># @def save(file, format=None, **options)</span>
    <span class="c"># @param file File name or file object.</span>
    <span class="c"># @param format Optional format override.  If omitted, the</span>
    <span class="c">#    format to use is determined from the filename extension.</span>
    <span class="c">#    If a file object was used instead of a filename, this</span>
    <span class="c">#    parameter should always be used.</span>
    <span class="c"># @param **options Extra parameters to the image writer.</span>
    <span class="c"># @return None</span>
    <span class="c"># @exception KeyError If the output format could not be determined</span>
    <span class="c">#    from the file name.  Use the format option to solve this.</span>
    <span class="c"># @exception IOError If the file could not be written.  The file</span>
    <span class="c">#    may have been created, and may contain partial data.</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="s">&quot;Save image to file or stream&quot;</span>

        <span class="k">if</span> <span class="n">isStringType</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">fp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isStringType</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="c"># may mutate self!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encoderinfo</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoderconfig</span> <span class="o">=</span> <span class="p">()</span>

        <span class="n">preinit</span><span class="p">()</span>

        <span class="n">ext</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">format</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">format</span> <span class="o">=</span> <span class="n">EXTENSION</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">init</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">format</span> <span class="o">=</span> <span class="n">EXTENSION</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="c"># unknown extension</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">save_handler</span> <span class="o">=</span> <span class="n">SAVE</span><span class="p">[</span><span class="n">string</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span><span class="n">format</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">init</span><span class="p">()</span>
            <span class="n">save_handler</span> <span class="o">=</span> <span class="n">SAVE</span><span class="p">[</span><span class="n">string</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span><span class="n">format</span><span class="p">)]</span> <span class="c"># unknown format</span>

        <span class="k">if</span> <span class="n">isStringType</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">__builtin__</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">__builtin__</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span>
            <span class="n">close</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">close</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">save_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c"># do what we can to clean up</span>
            <span class="k">if</span> <span class="n">close</span><span class="p">:</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c">##</span>
    <span class="c"># Seeks to the given frame in this sequence file. If you seek</span>
    <span class="c"># beyond the end of the sequence, the method raises an</span>
    <span class="c"># &lt;b&gt;EOFError&lt;/b&gt; exception. When a sequence file is opened, the</span>
    <span class="c"># library automatically seeks to frame 0.</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># Note that in the current version of the library, most sequence</span>
    <span class="c"># formats only allows you to seek to the next frame.</span>
    <span class="c">#</span>
    <span class="c"># @param frame Frame number, starting at 0.</span>
    <span class="c"># @exception EOFError If the call attempts to seek beyond the end</span>
    <span class="c">#     of the sequence.</span>
    <span class="c"># @see #Image.tell</span>

    <span class="k">def</span> <span class="nf">seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="s">&quot;Seek to given frame in sequence file&quot;</span>

        <span class="c"># overridden by file handlers</span>
        <span class="k">if</span> <span class="n">frame</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">EOFError</span>

    <span class="c">##</span>
    <span class="c"># Displays this image. This method is mainly intended for</span>
    <span class="c"># debugging purposes.</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># On Unix platforms, this method saves the image to a temporary</span>
    <span class="c"># PPM file, and calls the &lt;b&gt;xv&lt;/b&gt; utility.</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># On Windows, it saves the image to a temporary BMP file, and uses</span>
    <span class="c"># the standard BMP display utility to show it (usually Paint).</span>
    <span class="c">#</span>
    <span class="c"># @def show(title=None)</span>
    <span class="c"># @param title Optional title to use for the image window,</span>
    <span class="c">#    where possible.</span>

    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">&quot;Display image (for debug purposes only)&quot;</span>

        <span class="n">_show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Split this image into individual bands. This method returns a</span>
    <span class="c"># tuple of individual image bands from an image. For example,</span>
    <span class="c"># splitting an &quot;RGB&quot; image creates three new images each</span>
    <span class="c"># containing a copy of one of the original bands (red, green,</span>
    <span class="c"># blue).</span>
    <span class="c">#</span>
    <span class="c"># @return A tuple containing bands.</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Split image into bands&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">bands</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ims</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ims</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">bands</span><span class="p">):</span>
                <span class="n">ims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">getband</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ims</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Returns the current frame number.</span>
    <span class="c">#</span>
    <span class="c"># @return Frame number, starting with 0.</span>
    <span class="c"># @see #Image.seek</span>

    <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Return current frame number&quot;</span>

        <span class="k">return</span> <span class="mi">0</span>

    <span class="c">##</span>
    <span class="c"># Make this image into a thumbnail.  This method modifies the</span>
    <span class="c"># image to contain a thumbnail version of itself, no larger than</span>
    <span class="c"># the given size.  This method calculates an appropriate thumbnail</span>
    <span class="c"># size to preserve the aspect of the image, calls the {@link</span>
    <span class="c"># #Image.draft} method to configure the file reader (where</span>
    <span class="c"># applicable), and finally resizes the image.</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># Note that the bilinear and bicubic filters in the current</span>
    <span class="c"># version of PIL are not well-suited for thumbnail generation.</span>
    <span class="c"># You should use &lt;b&gt;ANTIALIAS&lt;/b&gt; unless speed is much more</span>
    <span class="c"># important than quality.</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># Also note that this function modifies the Image object in place.</span>
    <span class="c"># If you need to use the full resolution image as well, apply this</span>
    <span class="c"># method to a {@link #Image.copy} of the original image.</span>
    <span class="c">#</span>
    <span class="c"># @param size Requested size.</span>
    <span class="c"># @param resample Optional resampling filter.  This can be one</span>
    <span class="c">#    of &lt;b&gt;NEAREST&lt;/b&gt;, &lt;b&gt;BILINEAR&lt;/b&gt;, &lt;b&gt;BICUBIC&lt;/b&gt;, or</span>
    <span class="c">#    &lt;b&gt;ANTIALIAS&lt;/b&gt; (best quality).  If omitted, it defaults</span>
    <span class="c">#    to &lt;b&gt;NEAREST&lt;/b&gt; (this will be changed to ANTIALIAS in a</span>
    <span class="c">#    future version).</span>
    <span class="c"># @return None</span>

    <span class="k">def</span> <span class="nf">thumbnail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="n">NEAREST</span><span class="p">):</span>
        <span class="s">&quot;Create thumbnail representation (modifies image in place)&quot;</span>

        <span class="c"># FIXME: the default resampling filter will be changed</span>
        <span class="c"># to ANTIALIAS in future versions</span>

        <span class="c"># preserve aspect ratio</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="n">x</span> <span class="o">=</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="n">y</span> <span class="o">=</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>

        <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">draft</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">resample</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">resample</span> <span class="o">!=</span> <span class="n">ANTIALIAS</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">NEAREST</span><span class="p">)</span> <span class="c"># fallback</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">im</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c"># FIXME: the different tranform methods need further explanation</span>
    <span class="c"># instead of bloating the method docs, add a separate chapter.</span>

    <span class="c">##</span>
    <span class="c"># Transforms this image.  This method creates a new image with the</span>
    <span class="c"># given size, and the same mode as the original, and copies data</span>
    <span class="c"># to the new image using the given transform.</span>
    <span class="c"># &lt;p&gt;</span>
    <span class="c"># @def transform(size, method, data, resample=NEAREST)</span>
    <span class="c"># @param size The output size.</span>
    <span class="c"># @param method The transformation method.  This is one of</span>
    <span class="c">#   &lt;b&gt;EXTENT&lt;/b&gt; (cut out a rectangular subregion), &lt;b&gt;AFFINE&lt;/b&gt;</span>
    <span class="c">#   (affine transform), &lt;b&gt;PERSPECTIVE&lt;/b&gt; (perspective</span>
    <span class="c">#   transform), &lt;b&gt;QUAD&lt;/b&gt; (map a quadrilateral to a</span>
    <span class="c">#   rectangle), or &lt;b&gt;MESH&lt;/b&gt; (map a number of source quadrilaterals</span>
    <span class="c">#   in one operation).</span>
    <span class="c"># @param data Extra data to the transformation method.</span>
    <span class="c"># @param resample Optional resampling filter.  It can be one of</span>
    <span class="c">#    &lt;b&gt;NEAREST&lt;/b&gt; (use nearest neighbour), &lt;b&gt;BILINEAR&lt;/b&gt;</span>
    <span class="c">#    (linear interpolation in a 2x2 environment), or</span>
    <span class="c">#    &lt;b&gt;BICUBIC&lt;/b&gt; (cubic spline interpolation in a 4x4</span>
    <span class="c">#    environment). If omitted, or if the image has mode</span>
    <span class="c">#    &quot;1&quot; or &quot;P&quot;, it is set to &lt;b&gt;NEAREST&lt;/b&gt;.</span>
    <span class="c"># @return An Image object.</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="n">NEAREST</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="s">&quot;Transform image&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">ImageTransformHandler</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">fill</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s">&quot;getdata&quot;</span><span class="p">):</span>
            <span class="c"># compatibility w. old-style transform objects</span>
            <span class="n">method</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;missing method data&quot;</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="n">MESH</span><span class="p">:</span>
            <span class="c"># list of quads</span>
            <span class="k">for</span> <span class="n">box</span><span class="p">,</span> <span class="n">quad</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">im</span><span class="o">.</span><span class="n">__transformer</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">QUAD</span><span class="p">,</span> <span class="n">quad</span><span class="p">,</span> <span class="n">resample</span><span class="p">,</span> <span class="n">fill</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">im</span><span class="o">.</span><span class="n">__transformer</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">resample</span><span class="p">,</span> <span class="n">fill</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">im</span>

    <span class="k">def</span> <span class="nf">__transformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
                      <span class="n">resample</span><span class="o">=</span><span class="n">NEAREST</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="c"># FIXME: this should be turned into a lazy operation (?)</span>

        <span class="n">w</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="n">AFFINE</span><span class="p">:</span>
            <span class="c"># change argument order to match implementation</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="n">EXTENT</span><span class="p">:</span>
            <span class="c"># convert extent to an affine transform</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">xs</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">/</span> <span class="n">w</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">/</span> <span class="n">h</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">AFFINE</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">xs</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">ys</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="n">PERSPECTIVE</span><span class="p">:</span>
            <span class="c"># change argument order to match implementation</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="n">QUAD</span><span class="p">:</span>
            <span class="c"># quadrilateral warp.  data specifies the four corners</span>
            <span class="c"># given as NW, SW, SE, and NE.</span>
            <span class="n">nw</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">];</span> <span class="n">sw</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">];</span> <span class="n">se</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">];</span> <span class="n">ne</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">nw</span><span class="p">;</span> <span class="n">As</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">w</span><span class="p">;</span> <span class="n">At</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">h</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="p">(</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="n">As</span><span class="p">,</span> <span class="p">(</span><span class="n">sw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="n">At</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">se</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">ne</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="n">As</span><span class="o">*</span><span class="n">At</span><span class="p">,</span>
                    <span class="n">y0</span><span class="p">,</span> <span class="p">(</span><span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y0</span><span class="p">)</span><span class="o">*</span><span class="n">As</span><span class="p">,</span> <span class="p">(</span><span class="n">sw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y0</span><span class="p">)</span><span class="o">*</span><span class="n">At</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">se</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">sw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ne</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">y0</span><span class="p">)</span><span class="o">*</span><span class="n">As</span><span class="o">*</span><span class="n">At</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;unknown transformation method&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">resample</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">NEAREST</span><span class="p">,</span> <span class="n">BILINEAR</span><span class="p">,</span> <span class="n">BICUBIC</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;unknown resampling filter&quot;</span><span class="p">)</span>

        <span class="n">image</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="s">&quot;P&quot;</span><span class="p">):</span>
            <span class="n">resample</span> <span class="o">=</span> <span class="n">NEAREST</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">transform2</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">im</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">resample</span><span class="p">,</span> <span class="n">fill</span><span class="p">)</span>

    <span class="c">##</span>
    <span class="c"># Returns a flipped or rotated copy of this image.</span>
    <span class="c">#</span>
    <span class="c"># @param method One of &lt;b&gt;FLIP_LEFT_RIGHT&lt;/b&gt;, &lt;b&gt;FLIP_TOP_BOTTOM&lt;/b&gt;,</span>
    <span class="c"># &lt;b&gt;ROTATE_90&lt;/b&gt;, &lt;b&gt;ROTATE_180&lt;/b&gt;, or &lt;b&gt;ROTATE_270&lt;/b&gt;.</span>

    <span class="k">def</span> <span class="nf">transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="s">&quot;Transpose image (flip or rotate in 90 degree steps)&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

<span class="c"># --------------------------------------------------------------------</span>
<span class="c"># Lazy operations</span>

<span class="k">class</span> <span class="nc">_ImageCrop</span><span class="p">(</span><span class="n">Image</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>

        <span class="n">Image</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">box</span>
        <span class="k">if</span> <span class="n">x1</span> <span class="o">&lt;</span> <span class="n">x0</span><span class="p">:</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="k">if</span> <span class="n">y1</span> <span class="o">&lt;</span> <span class="n">y0</span><span class="p">:</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="n">y0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">x1</span><span class="o">-</span><span class="n">x0</span><span class="p">,</span> <span class="n">y1</span><span class="o">-</span><span class="n">y0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__crop</span> <span class="o">=</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">im</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># lazy evaluation!</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__crop</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__crop</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__crop</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="o">.</span><span class="n">pixel_access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">)</span>

        <span class="c"># FIXME: future versions should optimize crop/paste</span>
        <span class="c"># sequences!</span>

<span class="c"># --------------------------------------------------------------------</span>
<span class="c"># Abstract handlers.</span>

<span class="k">class</span> <span class="nc">ImagePointHandler</span><span class="p">:</span>
    <span class="c"># used as a mixin by point transforms (for use with im.point)</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">ImageTransformHandler</span><span class="p">:</span>
    <span class="c"># used as a mixin by geometry transforms (for use with im.transform)</span>
    <span class="k">pass</span>

<span class="c"># --------------------------------------------------------------------</span>
<span class="c"># Factories</span>

<span class="c">#</span>
<span class="c"># Debugging</span>

<span class="k">def</span> <span class="nf">_wedge</span><span class="p">():</span>
    <span class="s">&quot;Create greyscale wedge (for debugging only)&quot;</span>

    <span class="k">return</span> <span class="n">Image</span><span class="p">()</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">wedge</span><span class="p">(</span><span class="s">&quot;L&quot;</span><span class="p">))</span>

<span class="c">##</span>
<span class="c"># Creates a new image with the given mode and size.</span>
<span class="c">#</span>
<span class="c"># @param mode The mode to use for the new image.</span>
<span class="c"># @param size A 2-tuple, containing (width, height) in pixels.</span>
<span class="c"># @param color What colour to use for the image.  Default is black.</span>
<span class="c">#    If given, this should be a single integer or floating point value</span>
<span class="c">#    for single-band modes, and a tuple for multi-band modes (one value</span>
<span class="c">#    per band).  When creating RGB images, you can also use colour</span>
<span class="c">#    strings as supported by the ImageColor module.  If the colour is</span>
<span class="c">#    None, the image is not initialised.</span>
<span class="c"># @return An Image object.</span>

<div class="viewcode-block" id="new"><a class="viewcode-back" href="../../index.html#PIL.Image.new">[docs]</a><span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="s">&quot;Create a new image&quot;</span>

    <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># don&#39;t initialize</span>
        <span class="k">return</span> <span class="n">Image</span><span class="p">()</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">isStringType</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
        <span class="c"># css3-style specifier</span>

        <span class="kn">import</span> <span class="nn">ImageColor</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">ImageColor</span><span class="o">.</span><span class="n">getcolor</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Image</span><span class="p">()</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">color</span><span class="p">))</span>

<span class="c">##</span>
<span class="c"># Creates an image memory from pixel data in a string.</span>
<span class="c"># &lt;p&gt;</span>
<span class="c"># In its simplest form, this function takes three arguments</span>
<span class="c"># (mode, size, and unpacked pixel data).</span>
<span class="c"># &lt;p&gt;</span>
<span class="c"># You can also use any pixel decoder supported by PIL.  For more</span>
<span class="c"># information on available decoders, see the section &lt;a</span>
<span class="c"># href=&quot;pil-decoder.htm&quot;&gt;&lt;i&gt;Writing Your Own File Decoder&lt;/i&gt;&lt;/a&gt;.</span>
<span class="c"># &lt;p&gt;</span>
<span class="c"># Note that this function decodes pixel data only, not entire images.</span>
<span class="c"># If you have an entire image in a string, wrap it in a</span>
<span class="c"># &lt;b&gt;StringIO&lt;/b&gt; object, and use {@link #open} to load it.</span>
<span class="c">#</span>
<span class="c"># @param mode The image mode.</span>
<span class="c"># @param size The image size.</span>
<span class="c"># @param data An 8-bit string containing raw data for the given mode.</span>
<span class="c"># @param decoder_name What decoder to use.</span>
<span class="c"># @param *args Additional parameters for the given decoder.</span>
<span class="c"># @return An Image object.</span>
</div>
<div class="viewcode-block" id="fromstring"><a class="viewcode-back" href="../../index.html#PIL.Image.fromstring">[docs]</a><span class="k">def</span> <span class="nf">fromstring</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">decoder_name</span><span class="o">=</span><span class="s">&quot;raw&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="s">&quot;Load image from string&quot;</span>

    <span class="c"># may pass tuple instead of argument list</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">isTupleType</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">decoder_name</span> <span class="o">==</span> <span class="s">&quot;raw&quot;</span> <span class="ow">and</span> <span class="n">args</span> <span class="o">==</span> <span class="p">():</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">mode</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">im</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">decoder_name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">im</span>

<span class="c">##</span>
<span class="c"># (New in 1.1.4) Creates an image memory from pixel data in a string</span>
<span class="c"># or byte buffer.</span>
<span class="c"># &lt;p&gt;</span>
<span class="c"># This function is similar to {@link #fromstring}, but uses data in</span>
<span class="c"># the byte buffer, where possible.  This means that changes to the</span>
<span class="c"># original buffer object are reflected in this image).  Not all modes</span>
<span class="c"># can share memory; supported modes include &quot;L&quot;, &quot;RGBX&quot;, &quot;RGBA&quot;, and</span>
<span class="c"># &quot;CMYK&quot;.</span>
<span class="c"># &lt;p&gt;</span>
<span class="c"># Note that this function decodes pixel data only, not entire images.</span>
<span class="c"># If you have an entire image file in a string, wrap it in a</span>
<span class="c"># &lt;b&gt;StringIO&lt;/b&gt; object, and use {@link #open} to load it.</span>
<span class="c"># &lt;p&gt;</span>
<span class="c"># In the current version, the default parameters used for the &quot;raw&quot;</span>
<span class="c"># decoder differs from that used for {@link fromstring}.  This is a</span>
<span class="c"># bug, and will probably be fixed in a future release.  The current</span>
<span class="c"># release issues a warning if you do this; to disable the warning,</span>
<span class="c"># you should provide the full set of parameters.  See below for</span>
<span class="c"># details.</span>
<span class="c">#</span>
<span class="c"># @param mode The image mode.</span>
<span class="c"># @param size The image size.</span>
<span class="c"># @param data An 8-bit string or other buffer object containing raw</span>
<span class="c">#     data for the given mode.</span>
<span class="c"># @param decoder_name What decoder to use.</span>
<span class="c"># @param *args Additional parameters for the given decoder.  For the</span>
<span class="c">#     default encoder (&quot;raw&quot;), it&#39;s recommended that you provide the</span>
<span class="c">#     full set of parameters:</span>
<span class="c">#     &lt;b&gt;frombuffer(mode, size, data, &quot;raw&quot;, mode, 0, 1)&lt;/b&gt;.</span>
<span class="c"># @return An Image object.</span>
<span class="c"># @since 1.1.4</span>
</div>
<div class="viewcode-block" id="frombuffer"><a class="viewcode-back" href="../../index.html#PIL.Image.frombuffer">[docs]</a><span class="k">def</span> <span class="nf">frombuffer</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">decoder_name</span><span class="o">=</span><span class="s">&quot;raw&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="s">&quot;Load image from string or buffer&quot;</span>

    <span class="c"># may pass tuple instead of argument list</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">isTupleType</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">decoder_name</span> <span class="o">==</span> <span class="s">&quot;raw&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span> <span class="o">==</span> <span class="p">():</span>
            <span class="k">if</span> <span class="n">warnings</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s">&quot;the frombuffer defaults may change in a future release; &quot;</span>
                    <span class="s">&quot;for portability, change the call to read:</span><span class="se">\n</span><span class="s">&quot;</span>
                    <span class="s">&quot;  frombuffer(mode, size, data, &#39;raw&#39;, mode, 0, 1)&quot;</span><span class="p">,</span>
                    <span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
                <span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># may change to (mode, 0, 1) post-1.1.6</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">_MAPMODES</span><span class="p">:</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span>
                <span class="n">core</span><span class="o">.</span><span class="n">map_buffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">decoder_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">im</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">im</span>

    <span class="k">return</span> <span class="n">fromstring</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">decoder_name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>


<span class="c">##</span>
<span class="c"># (New in 1.1.6) Creates an image memory from an object exporting</span>
<span class="c"># the array interface (using the buffer protocol).</span>
<span class="c">#</span>
<span class="c"># If obj is not contiguous, then the tostring method is called</span>
<span class="c"># and {@link frombuffer} is used.</span>
<span class="c">#</span>
<span class="c"># @param obj Object with array interface</span>
<span class="c"># @param mode Mode to use (will be determined from type if None)</span>
<span class="c"># @return An image memory.</span>
</div>
<span class="k">def</span> <span class="nf">fromarray</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__array_interface__</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="s">&#39;shape&#39;</span><span class="p">]</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">strides</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="s">&#39;strides&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">strides</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">typekey</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">arr</span><span class="p">[</span><span class="s">&#39;typestr&#39;</span><span class="p">]</span>
            <span class="n">mode</span><span class="p">,</span> <span class="n">rawmode</span> <span class="o">=</span> <span class="n">_fromarray_typemap</span><span class="p">[</span><span class="n">typekey</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c"># print typekey</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Cannot handle this data type&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rawmode</span> <span class="o">=</span> <span class="n">mode</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="s">&quot;I&quot;</span><span class="p">,</span> <span class="s">&quot;P&quot;</span><span class="p">,</span> <span class="s">&quot;F&quot;</span><span class="p">]:</span>
        <span class="n">ndmax</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;RGB&quot;</span><span class="p">:</span>
        <span class="n">ndmax</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ndmax</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">if</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="n">ndmax</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Too many dimensions.&quot;</span><span class="p">)</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">strides</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">frombuffer</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="s">&quot;raw&quot;</span><span class="p">,</span> <span class="n">rawmode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">_fromarray_typemap</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c"># (shape, typestr) =&gt; mode, rawmode</span>
    <span class="c"># first two members of shape are set to one</span>
    <span class="c"># ((1, 1), &quot;|b1&quot;): (&quot;1&quot;, &quot;1&quot;), # broken</span>
    <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s">&quot;|u1&quot;</span><span class="p">):</span> <span class="p">(</span><span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="s">&quot;L&quot;</span><span class="p">),</span>
    <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s">&quot;|i1&quot;</span><span class="p">):</span> <span class="p">(</span><span class="s">&quot;I&quot;</span><span class="p">,</span> <span class="s">&quot;I;8&quot;</span><span class="p">),</span>
    <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s">&quot;&lt;i2&quot;</span><span class="p">):</span> <span class="p">(</span><span class="s">&quot;I&quot;</span><span class="p">,</span> <span class="s">&quot;I;16&quot;</span><span class="p">),</span>
    <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s">&quot;&gt;i2&quot;</span><span class="p">):</span> <span class="p">(</span><span class="s">&quot;I&quot;</span><span class="p">,</span> <span class="s">&quot;I;16B&quot;</span><span class="p">),</span>
    <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s">&quot;&lt;i4&quot;</span><span class="p">):</span> <span class="p">(</span><span class="s">&quot;I&quot;</span><span class="p">,</span> <span class="s">&quot;I;32&quot;</span><span class="p">),</span>
    <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s">&quot;&gt;i4&quot;</span><span class="p">):</span> <span class="p">(</span><span class="s">&quot;I&quot;</span><span class="p">,</span> <span class="s">&quot;I;32B&quot;</span><span class="p">),</span>
    <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s">&quot;&lt;f4&quot;</span><span class="p">):</span> <span class="p">(</span><span class="s">&quot;F&quot;</span><span class="p">,</span> <span class="s">&quot;F;32F&quot;</span><span class="p">),</span>
    <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s">&quot;&gt;f4&quot;</span><span class="p">):</span> <span class="p">(</span><span class="s">&quot;F&quot;</span><span class="p">,</span> <span class="s">&quot;F;32BF&quot;</span><span class="p">),</span>
    <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s">&quot;&lt;f8&quot;</span><span class="p">):</span> <span class="p">(</span><span class="s">&quot;F&quot;</span><span class="p">,</span> <span class="s">&quot;F;64F&quot;</span><span class="p">),</span>
    <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s">&quot;&gt;f8&quot;</span><span class="p">):</span> <span class="p">(</span><span class="s">&quot;F&quot;</span><span class="p">,</span> <span class="s">&quot;F;64BF&quot;</span><span class="p">),</span>
    <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="s">&quot;|u1&quot;</span><span class="p">):</span> <span class="p">(</span><span class="s">&quot;RGB&quot;</span><span class="p">,</span> <span class="s">&quot;RGB&quot;</span><span class="p">),</span>
    <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="s">&quot;|u1&quot;</span><span class="p">):</span> <span class="p">(</span><span class="s">&quot;RGBA&quot;</span><span class="p">,</span> <span class="s">&quot;RGBA&quot;</span><span class="p">),</span>
    <span class="p">}</span>

<span class="c"># shortcuts</span>
<span class="n">_fromarray_typemap</span><span class="p">[((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">_ENDIAN</span> <span class="o">+</span> <span class="s">&quot;i4&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;I&quot;</span><span class="p">,</span> <span class="s">&quot;I&quot;</span><span class="p">)</span>
<span class="n">_fromarray_typemap</span><span class="p">[((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">_ENDIAN</span> <span class="o">+</span> <span class="s">&quot;f4&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;F&quot;</span><span class="p">,</span> <span class="s">&quot;F&quot;</span><span class="p">)</span>

<span class="c">##</span>
<span class="c"># Opens and identifies the given image file.</span>
<span class="c"># &lt;p&gt;</span>
<span class="c"># This is a lazy operation; this function identifies the file, but the</span>
<span class="c"># actual image data is not read from the file until you try to process</span>
<span class="c"># the data (or call the {@link #Image.load} method).</span>
<span class="c">#</span>
<span class="c"># @def open(file, mode=&quot;r&quot;)</span>
<span class="c"># @param file A filename (string) or a file object.  The file object</span>
<span class="c">#    must implement &lt;b&gt;read&lt;/b&gt;, &lt;b&gt;seek&lt;/b&gt;, and &lt;b&gt;tell&lt;/b&gt; methods,</span>
<span class="c">#    and be opened in binary mode.</span>
<span class="c"># @param mode The mode.  If given, this argument must be &quot;r&quot;.</span>
<span class="c"># @return An Image object.</span>
<span class="c"># @exception IOError If the file cannot be found, or the image cannot be</span>
<span class="c">#    opened and identified.</span>
<span class="c"># @see #new</span>

<div class="viewcode-block" id="open"><a class="viewcode-back" href="../../index.html#PIL.Image.open">[docs]</a><span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;r&quot;</span><span class="p">):</span>
    <span class="s">&quot;Open an image file, without loading the raster data&quot;</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s">&quot;r&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;bad mode&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">isStringType</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">__builtin__</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">fp</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">__builtin__</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

    <span class="n">prefix</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>

    <span class="n">preinit</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ID</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">factory</span><span class="p">,</span> <span class="n">accept</span> <span class="o">=</span> <span class="n">OPEN</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">accept</span> <span class="ow">or</span> <span class="n">accept</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">factory</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="n">init</span><span class="p">():</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ID</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">factory</span><span class="p">,</span> <span class="n">accept</span> <span class="o">=</span> <span class="n">OPEN</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">accept</span> <span class="ow">or</span> <span class="n">accept</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                    <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">factory</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">pass</span>

    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;cannot identify image file&quot;</span><span class="p">)</span>

<span class="c">#</span>
<span class="c"># Image processing.</span>

<span class="c">##</span>
<span class="c"># Creates a new image by interpolating between two input images, using</span>
<span class="c"># a constant alpha.</span>
<span class="c">#</span>
<span class="c"># &lt;pre&gt;</span>
<span class="c">#    out = image1 * (1.0 - alpha) + image2 * alpha</span>
<span class="c"># &lt;/pre&gt;</span>
<span class="c">#</span>
<span class="c"># @param im1 The first image.</span>
<span class="c"># @param im2 The second image.  Must have the same mode and size as</span>
<span class="c">#    the first image.</span>
<span class="c"># @param alpha The interpolation alpha factor.  If alpha is 0.0, a</span>
<span class="c">#    copy of the first image is returned. If alpha is 1.0, a copy of</span>
<span class="c">#    the second image is returned. There are no restrictions on the</span>
<span class="c">#    alpha value. If necessary, the result is clipped to fit into</span>
<span class="c">#    the allowed output range.</span>
<span class="c"># @return An Image object.</span>
</div>
<div class="viewcode-block" id="blend"><a class="viewcode-back" href="../../index.html#PIL.Image.blend">[docs]</a><span class="k">def</span> <span class="nf">blend</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">im2</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
    <span class="s">&quot;Interpolate between images.&quot;</span>

    <span class="n">im1</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
    <span class="n">im2</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">im1</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">blend</span><span class="p">(</span><span class="n">im1</span><span class="o">.</span><span class="n">im</span><span class="p">,</span> <span class="n">im2</span><span class="o">.</span><span class="n">im</span><span class="p">,</span> <span class="n">alpha</span><span class="p">))</span>

<span class="c">##</span>
<span class="c"># Creates a new image by interpolating between two input images,</span>
<span class="c"># using the mask as alpha.</span>
<span class="c">#</span>
<span class="c"># @param image1 The first image.</span>
<span class="c"># @param image2 The second image.  Must have the same mode and</span>
<span class="c">#    size as the first image.</span>
<span class="c"># @param mask A mask image.  This image can can have mode</span>
<span class="c">#    &quot;1&quot;, &quot;L&quot;, or &quot;RGBA&quot;, and must have the same size as the</span>
<span class="c">#    other two images.</span>
</div>
<div class="viewcode-block" id="composite"><a class="viewcode-back" href="../../index.html#PIL.Image.composite">[docs]</a><span class="k">def</span> <span class="nf">composite</span><span class="p">(</span><span class="n">image1</span><span class="p">,</span> <span class="n">image2</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
    <span class="s">&quot;Create composite image by blending images using a transparency mask&quot;</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">image2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">image</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">image1</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span>

<span class="c">##</span>
<span class="c"># Applies the function (which should take one argument) to each pixel</span>
<span class="c"># in the given image. If the image has more than one band, the same</span>
<span class="c"># function is applied to each band. Note that the function is</span>
<span class="c"># evaluated once for each possible pixel value, so you cannot use</span>
<span class="c"># random components or other generators.</span>
<span class="c">#</span>
<span class="c"># @def eval(image, function)</span>
<span class="c"># @param image The input image.</span>
<span class="c"># @param function A function object, taking one integer argument.</span>
<span class="c"># @return An Image object.</span>
</div>
<div class="viewcode-block" id="eval"><a class="viewcode-back" href="../../index.html#PIL.Image.eval">[docs]</a><span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="s">&quot;Evaluate image expression&quot;</span>

    <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c">##</span>
<span class="c"># Creates a new image from a number of single-band images.</span>
<span class="c">#</span>
<span class="c"># @param mode The mode to use for the output image.</span>
<span class="c"># @param bands A sequence containing one single-band image for</span>
<span class="c">#     each band in the output image.  All bands must have the</span>
<span class="c">#     same size.</span>
<span class="c"># @return An Image object.</span>
</div>
<div class="viewcode-block" id="merge"><a class="viewcode-back" href="../../index.html#PIL.Image.merge">[docs]</a><span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">bands</span><span class="p">):</span>
    <span class="s">&quot;Merge a set of single band images into a new multiband image.&quot;</span>

    <span class="k">if</span> <span class="n">getmodebands</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;wrong number of bands&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="n">im</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">getmodetype</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;mode mismatch&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">im</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">bands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;size mismatch&quot;</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">bands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">getmodebands</span><span class="p">(</span><span class="n">mode</span><span class="p">)):</span>
        <span class="n">bands</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">im</span><span class="o">.</span><span class="n">putband</span><span class="p">(</span><span class="n">bands</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">im</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

<span class="c"># --------------------------------------------------------------------</span>
<span class="c"># Plugin registry</span>

<span class="c">##</span>
<span class="c"># Register an image file plugin.  This function should not be used</span>
<span class="c"># in application code.</span>
<span class="c">#</span>
<span class="c"># @param id An image format identifier.</span>
<span class="c"># @param factory An image file factory method.</span>
<span class="c"># @param accept An optional function that can be used to quickly</span>
<span class="c">#    reject images having another format.</span>
</div>
<span class="k">def</span> <span class="nf">register_open</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">factory</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">ID</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">OPEN</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">factory</span><span class="p">,</span> <span class="n">accept</span>

<span class="c">##</span>
<span class="c"># Registers an image MIME type.  This function should not be used</span>
<span class="c"># in application code.</span>
<span class="c">#</span>
<span class="c"># @param id An image format identifier.</span>
<span class="c"># @param mimetype The image MIME type for this format.</span>

<span class="k">def</span> <span class="nf">register_mime</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">mimetype</span><span class="p">):</span>
    <span class="n">MIME</span><span class="p">[</span><span class="n">string</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span><span class="nb">id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">mimetype</span>

<span class="c">##</span>
<span class="c"># Registers an image save function.  This function should not be</span>
<span class="c"># used in application code.</span>
<span class="c">#</span>
<span class="c"># @param id An image format identifier.</span>
<span class="c"># @param driver A function to save images in this format.</span>

<span class="k">def</span> <span class="nf">register_save</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">driver</span><span class="p">):</span>
    <span class="n">SAVE</span><span class="p">[</span><span class="n">string</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span><span class="nb">id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">driver</span>

<span class="c">##</span>
<span class="c"># Registers an image extension.  This function should not be</span>
<span class="c"># used in application code.</span>
<span class="c">#</span>
<span class="c"># @param id An image format identifier.</span>
<span class="c"># @param extension An extension used for this format.</span>

<span class="k">def</span> <span class="nf">register_extension</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">extension</span><span class="p">):</span>
    <span class="n">EXTENSION</span><span class="p">[</span><span class="n">string</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">extension</span><span class="p">)]</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>


<span class="c"># --------------------------------------------------------------------</span>
<span class="c"># Simple display support.  User code may override this.</span>

<span class="k">def</span> <span class="nf">_show</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="c"># override me, as necessary</span>
    <span class="nb">apply</span><span class="p">(</span><span class="n">_showxv</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="p">,),</span> <span class="n">options</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_showxv</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">ImageShow</span>
    <span class="nb">apply</span><span class="p">(</span><span class="n">ImageShow</span><span class="o">.</span><span class="n">show</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">title</span><span class="p">),</span> <span class="n">options</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../../index.html">M3 v0.6 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2010, БАРС Груп.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.5.
    </div>
  </body>
</html>